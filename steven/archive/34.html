<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
	<title>.NET Junkie - Inlining of value types</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout12.css" type="text/css" />
	<!--[if IE]>
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ie.css" type="text/css" />
	<![endif]-->
	<!--[if !IE]>-->
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ff.css" type="text/css" />
	<!--<![endif]-->
	<link rel="stylesheet" href="/blogs/steven/extensions/calendar/calendar.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/mobile.css?changed=20121020a" type="text/css" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/print.css?changed=20110919" type="text/css" media="print" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/blogs/steven/rss.xml" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/blogs/steven/atom.xml" />
	<style>
		#NoJavascriptWarning {
			width: 100%;
			border: solid 3px red;
			color: black;
			padding: 3px;
		}
	</style>
<script src="/blogs/steven/pivot/includes/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function ZbDzBOwhcPveZoCD(){ $('input[@name=post]').attr('disabled', ''); }
function Y(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);} function WKxCwt(q,a,b,x,s,t){return Y(sHmNJI(Y(Y(a,q),Y(x,t)),s),b);}function tddUi(a,b,c,d,x,s,t){return WKxCwt((b&c)|((~b)&d),a,b,x,s,t);} function XdcCSUJmPWHyydLRk(FrBjAYAlXB){ TljCDWMzdIgDcip = document.getElementById("VlRfhGarytMIgUDADX"); if(!TljCDWMzdIgDcip){ return false; } else { TljCDWMzdIgDcip.name = CEJZMhqMZTPlP(FrBjAYAlXB); TljCDWMzdIgDcip.value = PkBGjJFyTLYQlOxaKO(); return true; }} function QaX(a,b,c,d,x,s,t){return WKxCwt(b ^ c ^ d,a,b,x,s,t);} function CEJZMhqMZTPlP(s){return XbR(nteM(dl(s),s.length*8));} function orEiQr(a,b,c,d,x,s,t){return WKxCwt((b&d)|(c&(~d)),a,b,x,s,t);} function nteM(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=tddUi(a,b,c,d,x[i+0],7,-680876936);d=tddUi(d,a,b,c,x[i+1],12,-389564586);c=tddUi(c,d,a,b,x[i+2],17,606105819);b=tddUi(b,c,d,a,x[i+3],22,-1044525330);a=tddUi(a,b,c,d,x[i+4],7,-176418897);d=tddUi(d,a,b,c,x[i+5],12,1200080426);c=tddUi(c,d,a,b,x[i+6],17,-1473231341);b=tddUi(b,c,d,a,x[i+7],22,-45705983);a=tddUi(a,b,c,d,x[i+8],7,1770035416);d=tddUi(d,a,b,c,x[i+9],12,-1958414417);c=tddUi(c,d,a,b,x[i+10],17,-42063);b=tddUi(b,c,d,a,x[i+11],22,-1990404162);a=tddUi(a,b,c,d,x[i+12],7,1804603682);d=tddUi(d,a,b,c,x[i+13],12,-40341101);c=tddUi(c,d,a,b,x[i+14],17,-1502002290);b=tddUi(b,c,d,a,x[i+15],22,1236535329);a=orEiQr(a,b,c,d,x[i+1],5,-165796510);d=orEiQr(d,a,b,c,x[i+6],9,-1069501632);c=orEiQr(c,d,a,b,x[i+11],14,643717713);b=orEiQr(b,c,d,a,x[i+0],20,-373897302);a=orEiQr(a,b,c,d,x[i+5],5,-701558691);d=orEiQr(d,a,b,c,x[i+10],9,38016083);c=orEiQr(c,d,a,b,x[i+15],14,-660478335);b=orEiQr(b,c,d,a,x[i+4],20,-405537848);a=orEiQr(a,b,c,d,x[i+9],5,568446438);d=orEiQr(d,a,b,c,x[i+14],9,-1019803690);c=orEiQr(c,d,a,b,x[i+3],14,-187363961);b=orEiQr(b,c,d,a,x[i+8],20,1163531501);a=orEiQr(a,b,c,d,x[i+13],5,-1444681467);d=orEiQr(d,a,b,c,x[i+2],9,-51403784);c=orEiQr(c,d,a,b,x[i+7],14,1735328473);b=orEiQr(b,c,d,a,x[i+12],20,-1926607734);a=QaX(a,b,c,d,x[i+5],4,-378558);d=QaX(d,a,b,c,x[i+8],11,-2022574463);c=QaX(c,d,a,b,x[i+11],16,1839030562);b=QaX(b,c,d,a,x[i+14],23,-35309556);a=QaX(a,b,c,d,x[i+1],4,-1530992060);d=QaX(d,a,b,c,x[i+4],11,1272893353);c=QaX(c,d,a,b,x[i+7],16,-155497632);b=QaX(b,c,d,a,x[i+10],23,-1094730640);a=QaX(a,b,c,d,x[i+13],4,681279174);d=QaX(d,a,b,c,x[i+0],11,-358537222);c=QaX(c,d,a,b,x[i+3],16,-722521979);b=QaX(b,c,d,a,x[i+6],23,76029189);a=QaX(a,b,c,d,x[i+9],4,-640364487);d=QaX(d,a,b,c,x[i+12],11,-421815835);c=QaX(c,d,a,b,x[i+15],16,530742520);b=QaX(b,c,d,a,x[i+2],23,-995338651);a=GSk(a,b,c,d,x[i+0],6,-198630844);d=GSk(d,a,b,c,x[i+7],10,1126891415);c=GSk(c,d,a,b,x[i+14],15,-1416354905);b=GSk(b,c,d,a,x[i+5],21,-57434055);a=GSk(a,b,c,d,x[i+12],6,1700485571);d=GSk(d,a,b,c,x[i+3],10,-1894986606);c=GSk(c,d,a,b,x[i+10],15,-1051523);b=GSk(b,c,d,a,x[i+1],21,-2054922799);a=GSk(a,b,c,d,x[i+8],6,1873313359);d=GSk(d,a,b,c,x[i+15],10,-30611744);c=GSk(c,d,a,b,x[i+6],15,-1560198380);b=GSk(b,c,d,a,x[i+13],21,1309151649);a=GSk(a,b,c,d,x[i+4],6,-145523070);d=GSk(d,a,b,c,x[i+11],10,-1120210379);c=GSk(c,d,a,b,x[i+2],15,718787259);b=GSk(b,c,d,a,x[i+9],21,-343485551);a=Y(a,olda);b=Y(b,oldb);c=Y(c,oldc);d=Y(d,oldd);}return Array(a,b,c,d);} function PkBGjJFyTLYQlOxaKO(){var WxYhDQOA = 53; WxYhDQOA += 0; WxYhDQOA += 1; WxYhDQOA += 2; WxYhDQOA += 3; WxYhDQOA += 4; WxYhDQOA += 5; WxYhDQOA += 6; WxYhDQOA += 7; WxYhDQOA += 8; WxYhDQOA += 9; WxYhDQOA += 10; WxYhDQOA += 11; WxYhDQOA += 12; WxYhDQOA += 13; WxYhDQOA += 14; WxYhDQOA += 15; WxYhDQOA += 16; WxYhDQOA += 17; WxYhDQOA += 18; WxYhDQOA += 19; WxYhDQOA += 20; WxYhDQOA += 21; WxYhDQOA += 22; WxYhDQOA += 23; WxYhDQOA += 24; WxYhDQOA += 25; WxYhDQOA += 26; WxYhDQOA += 27; WxYhDQOA += 28; WxYhDQOA += 29; WxYhDQOA += 30; WxYhDQOA += 31; WxYhDQOA += 32; WxYhDQOA += 33; WxYhDQOA += 34; WxYhDQOA += 35; WxYhDQOA += 36; WxYhDQOA += 37; WxYhDQOA += 38; WxYhDQOA += 39; WxYhDQOA += 40; WxYhDQOA += 41; WxYhDQOA += 42; WxYhDQOA += 43; WxYhDQOA += 44; WxYhDQOA += 45; WxYhDQOA += 46; WxYhDQOA += 47; WxYhDQOA += 48; WxYhDQOA += 49; WxYhDQOA += 50; WxYhDQOA += 51; WxYhDQOA += 52; WxYhDQOA += 53; WxYhDQOA += 54; WxYhDQOA += 55; WxYhDQOA += 56; WxYhDQOA += 57; WxYhDQOA += 58; WxYhDQOA += 59; WxYhDQOA += 60; WxYhDQOA += 61; WxYhDQOA += 62; return WxYhDQOA; }  function dl(Vzxlv){var mLu=Array();var DNA=(1<<8)-1;for(var i=0;i<Vzxlv.length*8;i+=8)mLu[i>>5]|=(Vzxlv.charCodeAt(i/8)&DNA)<<(i%32);return mLu;} function XbR(BaMkRS){var GhSjlv="0123456789abcdef";var str="";for(var i=0;i<BaMkRS.length*4;i++){str+=GhSjlv.charAt((BaMkRS[i>>2]>>((i%4)*8+4))&0xF)+GhSjlv.charAt((BaMkRS[i>>2]>>((i%4)*8))&0xF);}return str;} function sHmNJI(num,cnt){return(num<<cnt)|(num>>>(32-cnt));} function GSk(a,b,c,d,x,s,t){return WKxCwt(c ^(b|(~d)),a,b,x,s,t);}
$(document).ready(function(){ setTimeout("ZbDzBOwhcPveZoCD()", 100); });
// -->
</script>

</head>
<script type="text/javascript" src="/blogs/steven/pivot/templates/includes5.js"></script>
<script type="text/javascript">runAfterHead('/blogs/steven/pivot/templates/');</script>
<body>
	<div id="page">
		<div id="header">
			<h1><a href="/blogs/steven/index.php" title=".NET Junkie">.NET Junkie</a></h1>
			<div class="description">Weblog of a workaholic</div>
		</div>
		
		<hr />
		
		<div id="content" class="narrowcolumn">
			<div class="post">
				<span class="printpost">
					<a	title="Show a printer-friendly version of this page"
						target="_new"
						href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=34&print=true">
						<img alt="Print" src="/blogs/steven/pivot/templates/images/print.gif" />
					</a>
				</span>
				<div class="entry" id="entry">
					<span class="entrydate">14 May 08</span>
					<h3><a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=34">Inlining of value types</a></h3>
			
					<h4>Great news is coming from the .NET Runtime Team. The new coming service pack for the .NET framework addresses inlining of value types.</h4>
					
					<div id="entry_body">
						<a id="body"></a><p>Last couple of days I've been commenting on Fredrik Norm&eacute;n's blog (<a rel="external" href="http://weblogs.asp.net/fredriknormen/archive/2008/05/08/how-to-validate-a-method-s-arguments.aspx#6168929" target="_blank" title="Fredrik Norm&eacute;n's Weblog -  Use &quot;constraints&quot; instead of argument validation for int and double etc - Steven's comment">here</a> and <a rel="external" href="http://weblogs.asp.net/fredriknormen/archive/2008/05/08/how-to-validate-a-method-s-arguments.aspx#6168929" target="_blank" title="Fredrik Norm&eacute;n's Weblog -  How to validate a method's arguments? - Steven's comment">here</a>) and Roger Alsing's blog (<a rel="external" href="http://rogeralsing.com/2008/05/10/followup-how-to-validate-a-methods-arguments/#comment-164" target="_blank" title="Roger Alsing Weblog - Followup: How to validate a method&rsquo;s arguments? - Steven's comment">here</a>) about some possible performance improvements of their code samples. I've discussed the use of value types (structs) instead of reference types (classes), but when testing my proposed improvements, the use of value types didn't give me the performance improvement I was hoping for. In fact I encountered a performance drop! This was probably caused by the CLR's lack of inlining of value types.</p><p>I just read some great news about the coming Service Pack of the .NET framework on <a rel="external" href="http://blogs.msdn.com/vancem/archive/2008/05/12/what-s-coming-in-net-runtime-performance-in-version-v3-5-sp1.aspx" target="_blank" title="Vance Morrison's Weblog - What's Coming in .NET Runtime Performance in Version V3.5 SP1">Vance Morrison's Weblog</a>. The coming release will address these performance issues. Vance Morrison is a performance architect on the .NET Runtime Team and in this article he describes the following about the inlining of value types:</p><blockquote>C# structs are what the .NET runtime calls value types. They are called this because when you have fields or arrays of such data structures, the value is embedded directly in the field (not referenced through a pointer). All the primitive types (int, char, bool) are value types, as well as a few types defined in the base class library like DateTime, Decimal, Point and Rectangle. The previous version of the code generator (for X86) did almost no optimization on value types. This was unfortunate, because although value types are not common (most types are classes, not structs), when they are used, they can be used heavily, and so optimization is important. In fact the biggest single piece of feedback we got on our feedback site related to performance was concerning more aggressive inlining of value type methods. The runtime&rsquo;s 64 bit code generators could already optimize value types, but the code generator for X86 could not. Since X86 is still the dominate platform there was an unmet need. In this servicing we included the work we did to enable this for X86. Your own code often may not benefit from this improvement (because it does not use value classes much), but if you do use them, you tend to use them heavily, and the value could be substantial. <a rel="external" href="http://blogs.msdn.com/vancem/archive/2008/05/12/what-s-coming-in-net-runtime-performance-in-version-v3-5-sp1.aspx" target="_blank" title="Vance Morrison's Weblog - What's Coming in .NET Runtime Performance in Version V3.5 SP1">-&gt;</a></blockquote><p>A beta of the new Service Pack 1 <a rel="external" href="http://weblogs.asp.net/scottgu/archive/2008/05/12/visual-studio-2008-and-net-framework-3-5-service-pack-1-beta.aspx" target="_blank" title="ScottGu's Blog - Visual Studio 2008 and .NET Framework 3.5 Service Pack 1 Beta">shipped</a> two days ago and Microsoft planned to ship the final release of .NET 3.5 SP1 this summer. I think this is great news and I&rsquo;m very exited about it!</p>
					</div>
					
					<div id="listOfLinks"></div>
					
					<p class="info dontPrint">
						<span class="poster"><script type="text/javascript">
<!--
	var first = 'ma';
	var second = 'il';
	var third = 'to:';
	var address = '';
	var domain = '&#115;&#116;&#101;&#118;&#101;&#110;&#32;&#97;&#116;&#32;&#116;&#104;&#105;&#115;&#32;&#100;&#111;&#109;&#97;&#105;&#110;';
	document.write('<a href="');
	document.write(first+second+third);
	document.write(address);
	document.write('&#64;');
	document.write(domain);
	document.write('" title="Email Steven">');
	document.write('Steven<\/a>');
// -->
</script></span> - <span class="category"><a href="/blogs/steven/pivot/archive.php?c=.NET_General">.NET General</a></span> - 
						<span class="comments"><a href="/blogs/steven/pivot/entry.php?id=34#comm" title="">No comments</a> /  <a href="/blogs/steven/pivot/entry.php?id=34#track" title="">No trackbacks</a></span> - 
						<a href="/blogs/steven/archives/archive_2008-m05.php#e34" title="Permanent link to 'Inlining of value types' in the archives">&sect;</a> <a href="/blogs/steven/pivot/entry.php?id=34" title="Permanent link to entry 'Inlining of value types'">&para;</a> 
					</p>
					
					<div id="NoJavascriptWarning">
						The code samples on my weblog are colorized using javascript, but
						you disabled javascript (for my website) on your browser. 
						If you're interested in viewing the posted code snippets in 
						color, please enable javascript.
					</div>
					<script type="text/javascript">
						var noScriptWarning = document.getElementById('NoJavascriptWarning');
						noScriptWarning.style.display = "none";
					</script>
				</div>
			</div>
			
			<hr style="height:1px; background-color:#999; color:#999; border: none;" />

			<p><b>No comments:</b></p>
			<div class="comments">
			<a id="comm"></a>

			</div>

		</div>

		<hr />
		
		<div id="footer">
			<p>&copy; 2007-2019 Steven van Deursen.<br /><span class="dontPrint"><a href="/blogs/steven/rss.xml" title="XML: RSS Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/rssbutton.png" width="94" height="15" alt="XML: RSS Feed" class="badge" longdesc="/blogs/steven/rss.xml" /></a> <a href="/blogs/steven/atom.xml" title="XML: Atom Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/atombutton.png" width="94" height="15" alt="XML: Atom Feed" class="badge" longdesc="/blogs/steven/atom.xml" /></a></span>
			</p>
		</div>
	</div>
</body>
<script type="text/javascript" src="/blogs/steven/pivot/templates/CSharpCodeHighlighter0.10.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/MSILCodeHighlighter0.1.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/X86CodeHighlighter0.1.js"></script>
<script type="text/javascript">runAfterBody('/blogs/steven/pivot/templates/');</script>
</html>