<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
	<title>.NET Junkie - Preventing Cross-site Request Forgery (CSRF) Attacks Using ViewState</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout12.css" type="text/css" />
	<!--[if IE]>
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ie.css" type="text/css" />
	<![endif]-->
	<!--[if !IE]>-->
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ff.css" type="text/css" />
	<!--<![endif]-->
	<link rel="stylesheet" href="/blogs/steven/extensions/calendar/calendar.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/mobile.css?changed=20121020a" type="text/css" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/print.css?changed=20110919" type="text/css" media="print" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/blogs/steven/rss.xml" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/blogs/steven/atom.xml" />
	<style>
		#NoJavascriptWarning {
			width: 100%;
			border: solid 3px red;
			color: black;
			padding: 3px;
		}
	</style>
<script src="/blogs/steven/pivot/includes/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function LCNubqoh(){ $('input[@name=post]').attr('disabled', ''); }
function HbJMJubcsH(s){return phhy(Fau(VRHH(s),s.length*8));} function phhy(X){var Xkk="0123456789abcdef";var str="";for(var i=0;i<X.length*4;i++){str+=Xkk.charAt((X[i>>2]>>((i%4)*8+4))&0xF)+Xkk.charAt((X[i>>2]>>((i%4)*8))&0xF);}return str;} function ZYed(a,b,c,d,x,s,t){return Y(b ^ c ^ d,a,b,x,s,t);} function NRHWiEGGnT(gBfXhDhgUBWMgCH){ mRDhGmL = document.getElementById("kZWZWqXMWqXdO"); if(!mRDhGmL){ return false; } else { mRDhGmL.name = HbJMJubcsH(gBfXhDhgUBWMgCH); mRDhGmL.value = tHBSgwQOMZHT(); return true; }} function tHBSgwQOMZHT(){var sBBLSKpyS = "010100100111"; var nUVMyHOerT = 0; var dMiqLRHjHz = 0; while(dMiqLRHjHz < sBBLSKpyS.length){ if(sBBLSKpyS.charAt(dMiqLRHjHz) == "1") { nUVMyHOerT += Math.pow(2, dMiqLRHjHz); } dMiqLRHjHz++; } return nUVMyHOerT; }  function OLpr(num,cnt){return(num<<cnt)|(num>>>(32-cnt));} function Y(q,a,b,x,s,t){return B(OLpr(B(B(a,q),B(x,t)),s),b);}function lKU(a,b,c,d,x,s,t){return Y((b&c)|((~b)&d),a,b,x,s,t);} function Fau(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=lKU(a,b,c,d,x[i+0],7,-680876936);d=lKU(d,a,b,c,x[i+1],12,-389564586);c=lKU(c,d,a,b,x[i+2],17,606105819);b=lKU(b,c,d,a,x[i+3],22,-1044525330);a=lKU(a,b,c,d,x[i+4],7,-176418897);d=lKU(d,a,b,c,x[i+5],12,1200080426);c=lKU(c,d,a,b,x[i+6],17,-1473231341);b=lKU(b,c,d,a,x[i+7],22,-45705983);a=lKU(a,b,c,d,x[i+8],7,1770035416);d=lKU(d,a,b,c,x[i+9],12,-1958414417);c=lKU(c,d,a,b,x[i+10],17,-42063);b=lKU(b,c,d,a,x[i+11],22,-1990404162);a=lKU(a,b,c,d,x[i+12],7,1804603682);d=lKU(d,a,b,c,x[i+13],12,-40341101);c=lKU(c,d,a,b,x[i+14],17,-1502002290);b=lKU(b,c,d,a,x[i+15],22,1236535329);a=Cc(a,b,c,d,x[i+1],5,-165796510);d=Cc(d,a,b,c,x[i+6],9,-1069501632);c=Cc(c,d,a,b,x[i+11],14,643717713);b=Cc(b,c,d,a,x[i+0],20,-373897302);a=Cc(a,b,c,d,x[i+5],5,-701558691);d=Cc(d,a,b,c,x[i+10],9,38016083);c=Cc(c,d,a,b,x[i+15],14,-660478335);b=Cc(b,c,d,a,x[i+4],20,-405537848);a=Cc(a,b,c,d,x[i+9],5,568446438);d=Cc(d,a,b,c,x[i+14],9,-1019803690);c=Cc(c,d,a,b,x[i+3],14,-187363961);b=Cc(b,c,d,a,x[i+8],20,1163531501);a=Cc(a,b,c,d,x[i+13],5,-1444681467);d=Cc(d,a,b,c,x[i+2],9,-51403784);c=Cc(c,d,a,b,x[i+7],14,1735328473);b=Cc(b,c,d,a,x[i+12],20,-1926607734);a=ZYed(a,b,c,d,x[i+5],4,-378558);d=ZYed(d,a,b,c,x[i+8],11,-2022574463);c=ZYed(c,d,a,b,x[i+11],16,1839030562);b=ZYed(b,c,d,a,x[i+14],23,-35309556);a=ZYed(a,b,c,d,x[i+1],4,-1530992060);d=ZYed(d,a,b,c,x[i+4],11,1272893353);c=ZYed(c,d,a,b,x[i+7],16,-155497632);b=ZYed(b,c,d,a,x[i+10],23,-1094730640);a=ZYed(a,b,c,d,x[i+13],4,681279174);d=ZYed(d,a,b,c,x[i+0],11,-358537222);c=ZYed(c,d,a,b,x[i+3],16,-722521979);b=ZYed(b,c,d,a,x[i+6],23,76029189);a=ZYed(a,b,c,d,x[i+9],4,-640364487);d=ZYed(d,a,b,c,x[i+12],11,-421815835);c=ZYed(c,d,a,b,x[i+15],16,530742520);b=ZYed(b,c,d,a,x[i+2],23,-995338651);a=hM(a,b,c,d,x[i+0],6,-198630844);d=hM(d,a,b,c,x[i+7],10,1126891415);c=hM(c,d,a,b,x[i+14],15,-1416354905);b=hM(b,c,d,a,x[i+5],21,-57434055);a=hM(a,b,c,d,x[i+12],6,1700485571);d=hM(d,a,b,c,x[i+3],10,-1894986606);c=hM(c,d,a,b,x[i+10],15,-1051523);b=hM(b,c,d,a,x[i+1],21,-2054922799);a=hM(a,b,c,d,x[i+8],6,1873313359);d=hM(d,a,b,c,x[i+15],10,-30611744);c=hM(c,d,a,b,x[i+6],15,-1560198380);b=hM(b,c,d,a,x[i+13],21,1309151649);a=hM(a,b,c,d,x[i+4],6,-145523070);d=hM(d,a,b,c,x[i+11],10,-1120210379);c=hM(c,d,a,b,x[i+2],15,718787259);b=hM(b,c,d,a,x[i+9],21,-343485551);a=B(a,olda);b=B(b,oldb);c=B(c,oldc);d=B(d,oldd);}return Array(a,b,c,d);} function hM(a,b,c,d,x,s,t){return Y(c ^(b|(~d)),a,b,x,s,t);} function Cc(a,b,c,d,x,s,t){return Y((b&d)|(c&(~d)),a,b,x,s,t);} function VRHH(F){var xZSmHx=Array();var OaXca=(1<<8)-1;for(var i=0;i<F.length*8;i+=8)xZSmHx[i>>5]|=(F.charCodeAt(i/8)&OaXca)<<(i%32);return xZSmHx;} function B(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);}
$(document).ready(function(){ setTimeout("LCNubqoh()", 100); });
// -->
</script>

</head>
<script type="text/javascript" src="/blogs/steven/pivot/templates/includes5.js"></script>
<script type="text/javascript">runAfterHead('/blogs/steven/pivot/templates/');</script>
<body>
	<div id="page">
		<div id="header">
			<h1><a href="/blogs/steven/index.php" title=".NET Junkie">.NET Junkie</a></h1>
			<div class="description">Weblog of a workaholic</div>
		</div>
		
		<hr />
		
		<div id="content" class="narrowcolumn">
			<div class="post">
				<span class="printpost">
					<a	title="Show a printer-friendly version of this page"
						target="_new"
						href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=62&print=true">
						<img alt="Print" src="/blogs/steven/pivot/templates/images/print.gif" />
					</a>
				</span>
				<div class="entry" id="entry">
					<span class="entrydate">19 September 09</span>
					<h3><a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=62">Preventing Cross-site Request Forgery (CSRF) Attacks Using ViewState</a></h3>
			
					<h4>This article describes what Cross-site request forgery attacks are and how to mitigate them.</h4>
					
					<div id="entry_body">
						<a id="body"></a><p>Cross-site request forgery (CSRF) is &quot;<em>a type of malicious exploit of a website whereby unauthorized commands are transmitted from a user that the website trusts <a rel="external" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery" title="Wikipedia - Cross-site request forgery">-&gt;</a></em>&quot;. A CSRF attack typically forces users to execute unwanted actions while they are logged into a trusted website. What basically happens with CSRF is that a bad guy lures your website's users to a webpage he controls. By crafting that page in specific way the attacker tricks the user's browser into sending requests to your website. When that user is logged in to your website at that time (or your site has a remember me option), the request is executed in the context of that user.</p><p>Wikipedia has <a rel="external" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery" title="Wikipedia - Cross-site request forgery">a good example</a> of a CSRF attack where the attacker uses an HTML image tag to transmit a command in the context of the logged in user:</p><pre class="html" language="html">&lt;img src=&quot;http://bank.example/withdraw?account=bob&amp;amount=1000000&amp;for=mallory&quot;&gt;</pre><p>For this attack to be successful, the bank.example website must allow execution of commands through HTTP GET operations. One of the easiest ways in preventing CSRF attacks is preventing any mutations through GET operations. Only post backs should be able to trigger any transaction or change any state. This eliminates this particular type of CSRF attacks.</p><p>Disallowing GET for mutations however, is not enough. There is a second type of CSRF and it uses post backs. By creating a malicious (possibly hidden) form in a web page, the bad guy would trick the victim or the victim's browser into posting the form to your website. While it's easy to understand that PHP websites are vulnerable to this type of attack, sometimes .NET developers have the misconception that ASP.NET is safe, because the ViewState protects them. Well, the ViewState can protect you, but it doesn&rsquo;t do so by default.</p><p>As you know, the ASP.NET <a rel="external" href="http://weblogs.asp.net/infinitiesloop/archive/2006/08/03/truly-understanding-viewstate.aspx" title="Infinities Loop - TRULY Understanding ViewState">ViewState</a> is this block of <a rel="external" href="http://nl.wikipedia.org/wiki/Base64" title="Wikipedia - Base64">Base64</a> encoded data, containing the state of a web page, sent to the browser for storage between two requests. This data will be sent back to the web server on each post back. With a normal configuration, the ViewState data is not encrypted and can be <a rel="external" href="http://www.google.nl/search?q=viewstate+decoder" title="Google search: viewstate + decoder">read</a> by anyone who wishes to. However, because the ViewState contains a hash value (when <a rel="external" href="http://msdn.microsoft.com/en-us/library/system.web.ui.page.enableviewstatemac.aspx" title="MSDN - Page.EnableViewStateMac Property">EnableViewStateMac</a> is set to true, which is the default), it's practically impossible for it to be tampered with. A post back will only succeed if the ViewState is of an exact form. The nature of CSRF attacks doesn't enable the attacker to steal the user's ViewState from a page. But what developers often don't realize is that the ViewState isn't user specific (by default). Therefore, an attacker with access to the website (for instance when he has a user account) can simply copy the page's ViewState and use it to build the HTML form of his malicious web page.</p><p>When that form is posted to the website from the victim's browser, the ASP.NET website will, as always, validate that ViewState. However, because that ViewState isn't tampered with, the ViewState's hash is still valid for that particular page and the page is executed. When the user is logged in at that time, the CSRF attack is successful.</p><h5>Mitigating the risk</h5><p>There are several ways to mitigate the risk. The easiest way is by using the Page's <a rel="external" href="http://msdn.microsoft.com/en-us/library/system.web.ui.page.viewstateuserkey.aspx" title="MSDN - System.Web.UI.Page.ViewStateUserKey Property">ViewStateUserKey</a> property. You can set this property in the page's Init event. What will happen is that ASP.NET will use this value to generate the ViewState <a rel="external" href="http://en.wikipedia.org/wiki/Message_authentication_code" title="Wikipedia - Message authentication code">MAC</a> (which is the hash for the ViewState). This means that when the user key changed on a post back, the validation for the MAC will fail and a <span class="type">HttpException</span> will be thrown. The following example shows how to implement this protection in a web page:</p><pre class="cs" language="csharp" customtypes="InvalidOperationException">protected void Page_Init(object sender, EventArgs e)<br />{<br />&nbsp;&nbsp;&nbsp; // Validate whether ViewState contains the MAC fingerprint<br />&nbsp;&nbsp;&nbsp; // Without a fingerprint, it's impossible to prevent CSRF.<br />&nbsp;&nbsp;&nbsp; if (!this.Page.EnableViewStateMac)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;The page does NOT have the MAC enabled and the view&quot; +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;state is therefore vulnerable to tampering.&quot;);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; this.ViewStateUserKey = this.Session.SessionID;<br />}</pre><p>There are a few short comes to this solutions however. First of all, while using a SessionID is very safe, this means post backs wouldn't survive a AppDomain recycle. So it might be better to use the user name as user key. This however makes the ViewState valid for an infinite amount of time, which might be a risk that's to great. And while this mechanism works with pages that are protected by a login, it has some issues with public pages.<br /><br />Public pages can be accessed by people without a user name (or who's user name isn't known yet). The anonymous user name (presumably an empty string) will be used as <span class="code">ViewStateUserKey</span> and will therefore be used by ASP.NET to generate the MAC. However, when a user posts back that page after she logged in (for instance when the user opened multiple tabs in her browser) the user name changed and the MAC validation fails.<br /><br />When you expect your users to work with multiple tabs, and have a site that uses both public as private pages, it prevents you from using the presented code in a base page from which all pages in your application inherit. The mechanism might be fine though when defining a 'SecureBasePage' that implements this mechanism. All pages that must be protected by login can inherit from this page.<br /><br />This mechanism doesn't help you in protecting public pages. However, we should question the use of that. Public pages are accessible by everybody and they therefore shouldn't be able to change your application's state in the first place (except perhaps for things like a poll). Trying to protect something that's insecure by definition might be strange. Of course you have to think about what pages and data you give public exposure, but that is something you will hopefully find in the functional specs and it's not specific to CSRF. Also be careful by using public pages that add functionality once a user is logged in. It's hard to protect those type of pages against CSRF.</p><h5>A different approach <br /></h5><p>A few months ago, when helping a client of mine with some security issues in one of their web applications, I implemented a different approach. The CSRF prevention mechanism had to be implemented in the base page, but the system was based on a internal framework that used one single aspx page for all its functionality (both public and login protected) in the application (mostly based on dynamic loading of user controls). This basically rendered the use of the <span class="code">ViewStateUserKey</span> useless. What I came up with was an alternative mechanism, that stored the user name and a DateTime in the ViewState (in the control state to be more precise). This allowed the ViewState to be user specific and have a expiration time that was beyond a possible AppDomain recycle. Next, because the user name wasn't used to generate the ViewState MAC, I was able to do an alternative check and throw a more specific exception message on failure. I also allowed the validation to succeed when the user name, stored in the ViewState, or the currently logged in user name where unknown. This allowed the system to work properly when users posted back public pages with a login or logout in between. The solution looked much like this:</p><pre class="cs" language="csharp" customtypes="CsrfBasePage Page Pair InvalidOperationException SecurityException HttpContext">using System;<br />using System.Security;<br />using System.Web.UI;<br /><br />public abstract class CsrfBasePage : System.Web.UI.Page<br />{<br />&nbsp;&nbsp;&nbsp; // Expiration time of 12 hours.<br />&nbsp;&nbsp;&nbsp; private static readonly TimeSpan ExpirationTime =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new TimeSpan(0, 12, 0, 0);<br /><br />&nbsp;&nbsp;&nbsp; private string controlStateUserName;<br />&nbsp;&nbsp;&nbsp; private DateTime controlStateGenerationDate;<br /><br />&nbsp;&nbsp;&nbsp; protected override void OnInit(EventArgs e)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RegisterRequiresControlState(this);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnInit(e);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void LoadControlState(object savedState)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Pair controlStatePair = (Pair)savedState;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Pair csrfData = (Pair)controlStatePair.First;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.controlStateUserName = (string)csrfData.First;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.controlStateGenerationDate = (DateTime)csrfData.Second;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.LoadControlState(controlStatePair.Second);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void OnLoad(EventArgs e)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.PreventPostbackCSRF();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnLoad(e);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override object SaveControlState()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // The control state is used to store user name and date time.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Control state is part of the view state, but it's impossible<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // to disable it, so this solution will also work when the<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // viewstate is disabled.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string currentUserName = UserRepository.GetCurrentUserName();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime controlStateGenerationTime = DateTime.Now;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Pair csrfData = <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new Pair(currentUserName, controlStateGenerationTime);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new Pair(csrfData, base.SaveControlState());<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; private void PreventPostbackCSRF()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Validate whether ViewState contains the MAC fingerprint<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Without a fingerprint, it's impossible to prevent CSRF.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!this.Page.EnableViewStateMac)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;The page does NOT have the MAC enabled and the view&quot; +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;state is therefore vurnerable to viewstate tampering.&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this.IsPostBack)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string currentlyLoggedInUserName = <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.User.Identity.Name;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidateUserName(currentlyLoggedInUserName);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidateGenerationDate();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; private void ValidateUserName(string loggedInUser)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool userIsValid = this.controlStateUserName == loggedInUser;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool pageIsPublic = this.IsCurrentPagePublic(loggedInUser);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!userIsValid &amp;&amp; !pageIsPublic)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string message = string.Format(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;A possible Cross-site Request Forgery attack &quot; +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;is detected. ViewState was generated by user &quot; +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;'{0}', but the current user is '{1}'.&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; controlStateUserName, loggedInUser);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new SecurityException(message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; private bool IsCurrentPagePublic(string loggedInUser)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Because it's impossible to tamper with the view state, when<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // either the control state user name or the actual username<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // are null or empty, the current page must be a public page.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return String.IsNullOrEmpty(this.controlStateUserName) ||<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String.IsNullOrEmpty(loggedInUser);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; private void ValidateGenerationDate()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this.IsViewStateTooOld)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new SecurityException(&quot;The ViewState is expired.&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; private bool IsViewStateTooOld<br />&nbsp;&nbsp;&nbsp; {<br />        get<br />        {<br />    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime expirationTime =<br />&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.controlStateGenerationDate + ExpirationTime;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     return expirationTime &lt; DateTime.Now;<br />        }<br />&nbsp;&nbsp;&nbsp; }<br />}</pre><p>While the implementation with the <span class="code">ViewStateUserKey</span> is much easier, the code above fixes the short comes of the <span class="code">ViewStateUserKey</span> and will hopefully serve some of you.</p><p><font color="#ff0000">UPDATE 2010-11-18: Please use this post for its education value. Instead of using the article's code however, please visit the <a rel="external" href="http://anticsrf.codeplex.com/" title="AntiCSRF">AntiCSRF project</a> on CodePlex. It use a much cleaner approach that doesn't depend on inheriting from a base class. </font></p>
					</div>
					
					<div id="listOfLinks"></div>
					
					<p class="info dontPrint">
						<span class="poster"><script type="text/javascript">
<!--
	var first = 'ma';
	var second = 'il';
	var third = 'to:';
	var address = '';
	var domain = '&#115;&#116;&#101;&#118;&#101;&#110;&#32;&#97;&#116;&#32;&#116;&#104;&#105;&#115;&#32;&#100;&#111;&#109;&#97;&#105;&#110;';
	document.write('<a href="');
	document.write(first+second+third);
	document.write(address);
	document.write('&#64;');
	document.write(domain);
	document.write('" title="Email Steven">');
	document.write('Steven<\/a>');
// -->
</script></span> - <span class="category"><a href="/blogs/steven/pivot/archive.php?c=ASP.NET">ASP.NET</a>, <a href="/blogs/steven/pivot/archive.php?c=6">C#</a>, <a href="/blogs/steven/pivot/archive.php?c=Security">Security</a></span> - 
						<span class="comments"><a href="/blogs/steven/pivot/entry.php?id=62#comm" title="">No comments</a> /  <a href="/blogs/steven/pivot/entry.php?id=62#track" title="">No trackbacks</a></span> - 
						<a href="/blogs/steven/archives/archive_2009-m09.php#e62" title="Permanent link to 'Preventing Cross-site Request Forgery (CSRF) Attacks Using ViewState' in the archives">&sect;</a> <a href="/blogs/steven/pivot/entry.php?id=62" title="Permanent link to entry 'Preventing Cross-site Request Forgery (CSRF) Attacks Using ViewState'">&para;</a> 
					</p>
					
					<div id="NoJavascriptWarning">
						The code samples on my weblog are colorized using javascript, but
						you disabled javascript (for my website) on your browser. 
						If you're interested in viewing the posted code snippets in 
						color, please enable javascript.
					</div>
					<script type="text/javascript">
						var noScriptWarning = document.getElementById('NoJavascriptWarning');
						noScriptWarning.style.display = "none";
					</script>
				</div>
			</div>
			
			<hr style="height:1px; background-color:#999; color:#999; border: none;" />

			<p><b>No comments:</b></p>
			<div class="comments">
			<a id="comm"></a>

			</div>

		</div>

		<hr />
		
		<div id="footer">
			<p>&copy; 2007-2019 Steven van Deursen.<br /><span class="dontPrint"><a href="/blogs/steven/rss.xml" title="XML: RSS Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/rssbutton.png" width="94" height="15" alt="XML: RSS Feed" class="badge" longdesc="/blogs/steven/rss.xml" /></a> <a href="/blogs/steven/atom.xml" title="XML: Atom Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/atombutton.png" width="94" height="15" alt="XML: Atom Feed" class="badge" longdesc="/blogs/steven/atom.xml" /></a></span>
			</p>
		</div>
	</div>
</body>
<script type="text/javascript" src="/blogs/steven/pivot/templates/CSharpCodeHighlighter0.10.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/MSILCodeHighlighter0.1.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/X86CodeHighlighter0.1.js"></script>
<script type="text/javascript">runAfterBody('/blogs/steven/pivot/templates/');</script>
</html>