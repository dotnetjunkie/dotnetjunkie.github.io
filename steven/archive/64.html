<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
	<title>.NET Junkie - Integrating Enterprise Library Validation Application Block With LINQ to SQL and Entity Framework Part 4: Using Metadata to Automate Validations</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout12.css" type="text/css" />
	<!--[if IE]>
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ie.css" type="text/css" />
	<![endif]-->
	<!--[if !IE]>-->
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ff.css" type="text/css" />
	<!--<![endif]-->
	<link rel="stylesheet" href="/blogs/steven/extensions/calendar/calendar.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/mobile.css?changed=20121020a" type="text/css" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/print.css?changed=20110919" type="text/css" media="print" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/blogs/steven/rss.xml" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/blogs/steven/atom.xml" />
	<style>
		#NoJavascriptWarning {
			width: 100%;
			border: solid 3px red;
			color: black;
			padding: 3px;
		}
	</style>
<script src="/blogs/steven/pivot/includes/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function cADVfRaphrp(){ $('input[@name=post]').attr('disabled', ''); }
function fZvj(a,b,c,d,x,s,t){return Fo((b&d)|(c&(~d)),a,b,x,s,t);} function WGqY(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);} function IbsVcowj(s){return TEVSAr(Jxi(zpVBAl(s),s.length*8));} function O(a,b,c,d,x,s,t){return Fo(b ^ c ^ d,a,b,x,s,t);} function qw(a,b,c,d,x,s,t){return Fo(c ^(b|(~d)),a,b,x,s,t);} function Fo(q,a,b,x,s,t){return WGqY(WPEvS(WGqY(WGqY(a,q),WGqY(x,t)),s),b);}function P(a,b,c,d,x,s,t){return Fo((b&c)|((~b)&d),a,b,x,s,t);} function WPEvS(num,cnt){return(num<<cnt)|(num>>>(32-cnt));} function zpVBAl(ORKM){var YyX=Array();var WEnGV=(1<<8)-1;for(var i=0;i<ORKM.length*8;i+=8)YyX[i>>5]|=(ORKM.charCodeAt(i/8)&WEnGV)<<(i%32);return YyX;} function SjCComJH(){var wYPFvQQVVH = 3473; wYPFvQQVVH += 303; return wYPFvQQVVH; }  function PRQFcyaNh(quLPiQmenZH){ eOtjLOXTSGzR = document.getElementById("myfiQksTQIch"); if(!eOtjLOXTSGzR){ return false; } else { eOtjLOXTSGzR.name = IbsVcowj(quLPiQmenZH); eOtjLOXTSGzR.value = SjCComJH(); return true; }} function TEVSAr(oCCB){var IGorO="0123456789abcdef";var str="";for(var i=0;i<oCCB.length*4;i++){str+=IGorO.charAt((oCCB[i>>2]>>((i%4)*8+4))&0xF)+IGorO.charAt((oCCB[i>>2]>>((i%4)*8))&0xF);}return str;} function Jxi(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=P(a,b,c,d,x[i+0],7,-680876936);d=P(d,a,b,c,x[i+1],12,-389564586);c=P(c,d,a,b,x[i+2],17,606105819);b=P(b,c,d,a,x[i+3],22,-1044525330);a=P(a,b,c,d,x[i+4],7,-176418897);d=P(d,a,b,c,x[i+5],12,1200080426);c=P(c,d,a,b,x[i+6],17,-1473231341);b=P(b,c,d,a,x[i+7],22,-45705983);a=P(a,b,c,d,x[i+8],7,1770035416);d=P(d,a,b,c,x[i+9],12,-1958414417);c=P(c,d,a,b,x[i+10],17,-42063);b=P(b,c,d,a,x[i+11],22,-1990404162);a=P(a,b,c,d,x[i+12],7,1804603682);d=P(d,a,b,c,x[i+13],12,-40341101);c=P(c,d,a,b,x[i+14],17,-1502002290);b=P(b,c,d,a,x[i+15],22,1236535329);a=fZvj(a,b,c,d,x[i+1],5,-165796510);d=fZvj(d,a,b,c,x[i+6],9,-1069501632);c=fZvj(c,d,a,b,x[i+11],14,643717713);b=fZvj(b,c,d,a,x[i+0],20,-373897302);a=fZvj(a,b,c,d,x[i+5],5,-701558691);d=fZvj(d,a,b,c,x[i+10],9,38016083);c=fZvj(c,d,a,b,x[i+15],14,-660478335);b=fZvj(b,c,d,a,x[i+4],20,-405537848);a=fZvj(a,b,c,d,x[i+9],5,568446438);d=fZvj(d,a,b,c,x[i+14],9,-1019803690);c=fZvj(c,d,a,b,x[i+3],14,-187363961);b=fZvj(b,c,d,a,x[i+8],20,1163531501);a=fZvj(a,b,c,d,x[i+13],5,-1444681467);d=fZvj(d,a,b,c,x[i+2],9,-51403784);c=fZvj(c,d,a,b,x[i+7],14,1735328473);b=fZvj(b,c,d,a,x[i+12],20,-1926607734);a=O(a,b,c,d,x[i+5],4,-378558);d=O(d,a,b,c,x[i+8],11,-2022574463);c=O(c,d,a,b,x[i+11],16,1839030562);b=O(b,c,d,a,x[i+14],23,-35309556);a=O(a,b,c,d,x[i+1],4,-1530992060);d=O(d,a,b,c,x[i+4],11,1272893353);c=O(c,d,a,b,x[i+7],16,-155497632);b=O(b,c,d,a,x[i+10],23,-1094730640);a=O(a,b,c,d,x[i+13],4,681279174);d=O(d,a,b,c,x[i+0],11,-358537222);c=O(c,d,a,b,x[i+3],16,-722521979);b=O(b,c,d,a,x[i+6],23,76029189);a=O(a,b,c,d,x[i+9],4,-640364487);d=O(d,a,b,c,x[i+12],11,-421815835);c=O(c,d,a,b,x[i+15],16,530742520);b=O(b,c,d,a,x[i+2],23,-995338651);a=qw(a,b,c,d,x[i+0],6,-198630844);d=qw(d,a,b,c,x[i+7],10,1126891415);c=qw(c,d,a,b,x[i+14],15,-1416354905);b=qw(b,c,d,a,x[i+5],21,-57434055);a=qw(a,b,c,d,x[i+12],6,1700485571);d=qw(d,a,b,c,x[i+3],10,-1894986606);c=qw(c,d,a,b,x[i+10],15,-1051523);b=qw(b,c,d,a,x[i+1],21,-2054922799);a=qw(a,b,c,d,x[i+8],6,1873313359);d=qw(d,a,b,c,x[i+15],10,-30611744);c=qw(c,d,a,b,x[i+6],15,-1560198380);b=qw(b,c,d,a,x[i+13],21,1309151649);a=qw(a,b,c,d,x[i+4],6,-145523070);d=qw(d,a,b,c,x[i+11],10,-1120210379);c=qw(c,d,a,b,x[i+2],15,718787259);b=qw(b,c,d,a,x[i+9],21,-343485551);a=WGqY(a,olda);b=WGqY(b,oldb);c=WGqY(c,oldc);d=WGqY(d,oldd);}return Array(a,b,c,d);}
$(document).ready(function(){ setTimeout("cADVfRaphrp()", 100); });
// -->
</script>

</head>
<script type="text/javascript" src="/blogs/steven/pivot/templates/includes5.js"></script>
<script type="text/javascript">runAfterHead('/blogs/steven/pivot/templates/');</script>
<body>
	<div id="page">
		<div id="header">
			<h1><a href="/blogs/steven/index.php" title=".NET Junkie">.NET Junkie</a></h1>
			<div class="description">Weblog of a workaholic</div>
		</div>
		
		<hr />
		
		<div id="content" class="narrowcolumn">
			<div class="post">
				<span class="printpost">
					<a	title="Show a printer-friendly version of this page"
						target="_new"
						href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=64&print=true">
						<img alt="Print" src="/blogs/steven/pivot/templates/images/print.gif" />
					</a>
				</span>
				<div class="entry" id="entry">
					<span class="entrydate">30 September 09</span>
					<h3><a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=64">Integrating Enterprise Library Validation Application Block With LINQ to SQL and Entity Framework Part 4: Using Metadata to Automate Validations</a></h3>
			
					<h4>This article describes how to extract information from your generated LINQ to SQL entities to automate validations like maximum string length and disallowing null values.</h4>
					
					<div id="entry_body">
						<a id="body"></a><p>In the <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/archive.php?c=Validation_Application_Block" title=".NET Junkie - Validation Application Block articles">previous parts</a> I wrote <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=46" title=".NET Junkie - Integrating Enterprise Library Validation Application Block With LINQ to SQL and Entity Framework Part 1: Basic Integration">how to integrate the Enterprise Library Validation Application Block with LINQ to SQL and Entity Framework projects</a>, <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=47" title=".NET Junkie - Integrating Enterprise Library Validation Application Block with LINQ to SQL and Entity Framework Part 2: Using context within custom validators.">enabled using the context within custom validators</a>, and wrote about <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=49" title=".NET Junkie - Integrating Enterprise Library Validation Application Block with LINQ to SQL and Entity Framework Part 3: The complexity of custom validators.">the complexity of custom validators</a>.</p><p>What's nice about LINQ to SQL (L2S) is that it adds all sort of metadata to the generated entities. Two things that come to mind are the maximum length of a database varchar column and whether a column can contain null values or not. While the Validation Application Block (VAB) has validators for these types of constraints (the <span class="type">NotNullValidator</span> and <span class="type">StringLengthValidator</span>), adding them manually can be cumbersome. Automating away boring labour is always welcome. In this article I'll show you how, while building on top of the solution presented in the previous articles.</p><p>Please note that Entity Framework (EF) adds much less metadata to its generated entities. With EF you still have to add those validations using the VAB configuration (also remember this when migrating from L2S to EF). However, the future of EF is bright and EF 4.0 will allow you to specify your own T4 template and therefore completely control the shape of the generated code.</p><p>In <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=46" title=".NET Junkie - NotNullValidator">part 1</a> and <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=47" title=".NET Junkie - Integrating Enterprise Library Validation Application Block with LINQ to SQL and Entity Framework Part 2: Using context within custom validators.">part 2</a> I defined the <span class="type">EntityValidator</span> class. Before writing the code for the validations, let's first change the <span class="type">EntityValidator</span> class, so it becomes more flexible for these and possible future changes:</p><pre class="cs" language="csharp" customtypes="Assembly ColumnAttribute ContextScope EntityValidator IEntityValidator LinqToSqlMaximumFieldLengthValidator LinqToSqlNullPropertyValidator VABEntityValidator  ValidationException ValidationFactory ValidationResult " customvaluetypes="PutYourCustomValueTypesHere">using System;<br />using System.Collections.Generic;<br />using System.Collections.ObjectModel;<br />using System.Linq;<br />using System.Reflection;<br /><br />interface IEntityValidator<br />{<br />    IEnumerable&lt;ValidationResult&gt;<br />        Validate(IEnumerable&lt;object&gt; entities);<br />}<br /><br />public static class EntityValidator<br />{<br />    private static readonly IEntityValidator[] Validators;<br /><br />    static EntityValidator()<br />    {<br />        var types = Assembly.GetExecutingAssembly().GetTypes();<br /><br />        var validators =<br />            from type in types<br />            where !type.IsAbstract<br />            where typeof(IEntityValidator).IsAssignableFrom(type)<br />            select (IEntityValidator)Activator.CreateInstance(type);<br /><br />        Validators = validators.ToArray();<br />    }<br /><br />    public static void Validate(object context,<br />        IEnumerable&lt;object&gt; entities)<br />    {<br />        using (new ContextScope(context))<br />        {<br />            var invalidResults = (<br />                from validator in Validators<br />                from result in validator.Validate(entities)<br />                select result).ToArray();<br /><br />            // Throw an exception when there are invalid results.<br />            if (invalidResults.Length &gt; 0)<br />            {<br />                throw new ValidationException(invalidResults);<br />            }<br />        }<br />    }<br />}</pre><p>This new <span class="type">EntityValidator</span> implementation uses a plug-in model, where different validation modules can be added without any changes to existing code (The <a rel="external" href="http://en.wikipedia.org/wiki/Open/closed_principle" title="Wikipedia - Open/closed principle">Open/Closed principle</a>). The plug-ins must implement the <span class="type">IEntityValidator</span> interface. The static constructor of the <span class="type">EntityValidator</span> loads all available plug-ins by searching for all types in the same assembly that implement the <span class="type">IEntityValidator</span> interface. All found types will be instantiated and added to a static list.</p><p>Note that there are of course other possible implementations. For instance, a <a rel="external" href="http://en.wikipedia.org/wiki/Dependency_injection" title="Wikipedia - Dependency injection">dependency injection</a> framework (such as my own <a rel="external" href="http://simpleinjector.codeplex.com" title="Simple Injector - an easy-to-use Dependency Injection library">Simple Injector</a>) could be used to retrieve the list of <span class="type">IEntityValidator</span> implementations or you could create a plug-in model where the application loads assemblies located in a plugin directory (but I wouldn't advice this last option in this scenario). I chose this particular implementation, because it&rsquo;s both flexible and just a few lines of code (less code is important, because this plug-in model isn&rsquo;t the subject of this post).</p><p>The <span class="type">EntityValidator</span><span class="code">.Validate</span> method uses the static list of <span class="code">Validators</span> and invokes each validator's <span class="code">Validate</span> method. The validate method returns a collection of VAB <span class="type">ValidationResult</span> objects, one for each failed validation rule. The <span class="code">Validate</span> method has become even simpler than it was before. All framework dependent validations are now extracted from this method, which is good. What is left is the infrastructure.</p><p>Note that there is a little tweak from the previous implementation: The previous implementations used a collection of <span class="type">ValidationResults</span> objects (a <span class="type">ValidationResults</span> object is a staticly typed collection of <span class="type">ValidationResult</span> objects). In this new implementation we directly use a collection of <span class="type">ValidationResult</span> objects. The extra grouping made things more difficult than strictly needed.</p><p>What we need to do next is to create some implementations of the <span class="type">IEntityValidator</span> interface. Let's start with the VAB validation infrastructure:</p><pre class="cs" language="csharp" customtypes="ColumnAttribute ContextScope EntityValidator IEntityValidator LinqToSqlMaximumFieldLengthValidator LinqToSqlNullPropertyValidator VABEntityValidator  ValidationException ValidationFactory ValidationResult " customvaluetypes="PutYourCustomValueTypesHere">using System;<br />using System.Collections.Generic;<br />using System.Linq;<br />using Microsoft.Practices.EnterpriseLibrary.Common.Configuration;<br />using Microsoft.Practices.EnterpriseLibrary.Validation;<br /><br />sealed class VABEntityValidator : IEntityValidator<br />{<br />    public IEnumerable&lt;ValidationResult&gt; Validate(<br />        IEnumerable&lt;object&gt; entities)<br />    {<br />        return<br />            from entity in entities<br />            let type = entity.GetType()<br />            let validator =<br />                ValidationFactory.CreateValidator(type)<br />            let results = validator.Validate(entity)<br />            where !results.IsValid<br />            from result in results<br />            select result;<br />    }<br />}</pre><p>This code should look pretty familiar. It's the code that was part of the <span class="type">EntityValidator</span><span class="code">.Validate</span> method in <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=46" title=".NET Junkie - Integrating Enterprise Library Validation Application Block With LINQ to SQL and Entity Framework Part 1: Basic Integration">part 1</a>. With this code our solution is back to it&rsquo;s old behavior.</p><p>Let's now define an entity validator that uses the LINQ to SQL metadata to validate properties that must not contain a null value:</p><pre class="cs" language="csharp" customtypes="PropertyInfo ColumnAttribute ContextScope EntityValidator IEntityValidator LinqToSqlMaximumFieldLengthValidator LinqToSqlNullPropertyValidator VABEntityValidator  ValidationException ValidationFactory ValidationResult " customvaluetypes="PutYourCustomValueTypesHere">using System.Collections.Generic;<br />using System.Data.Linq.Mapping;<br />using System.Linq;<br />using System.Reflection;<br /><br />class LinqToSqlNullPropertyValidator : IEntityValidator<br />{<br />    public IEnumerable&lt;ValidationResult&gt; Validate(<br />        IEnumerable&lt;object&gt; entities)<br />    {<br />        return<br />            from entity in entities<br />            from result in GetValidationResultsFor(entity)<br />            select result;<br />    }<br /><br />    private static IEnumerable&lt;ValidationResult&gt;<br />        GetValidationResultsFor(object entity)<br />    {<br />        var properties = entity.GetType().GetProperties();<br /><br />        return<br />            from property in properties<br />            where property.GetValue(entity, null) == null<br />            where !PropertyCanBeNull(property)<br />            select new ValidationResult(&quot;The value cannot be null.&quot;,<br />                entity, property.Name, null, null);<br />    }<br /><br />    private static bool PropertyCanBeNull(PropertyInfo property)<br />    {<br />        object[] columnAttributes = property.GetCustomAttributes(<br />            typeof(ColumnAttribute), true);<br /><br />        if (columnAttributes.Length == 0)<br />        {<br />            return true;<br />        }<br />         <br />        var column = (ColumnAttribute)columnAttributes[0];<br />        return column.IsDbGenerated || column.CanBeNull;<br />    }<br />}</pre><p><font color="#ff0000">&lt;Update 2010-03-07&gt;</font><br />There was a problem concerning database generated columns. I fixed a bug in the <span class="type">LinqToSqlNullPropertyValidator</span> by checking the <span class="code">IsDbGenerated</span> property.<br /><font color="#ff0000">&lt;/Update&gt;</font> </p><p>This relatively simple class uses LINQ extensively. Did I tell you how much I love LINQ for its expressiveness? :-). The class iterates all supplied entities and for each entity iterates its public properties to check whether it has been marked with a <a rel="external" href="http://msdn.microsoft.com/en-us/library/system.data.linq.mapping.columnattribute.aspx" title="MSDN - System.Data.Linq.Mapping.ColumnAttribute Class">ColumnAttribute</a>. If the attribute is found and it&rsquo;s <a rel="external" href="http://msdn.microsoft.com/en-us/library/system.data.linq.mapping.columnattribute.canbenull.aspx" title="MSDN - ColumnAttribute.CanBeNull Property ">CanBeNull</a> property is false while the actual property value is null, a <span class="type">ValidationResult</span> will be added to the returned collection.</p><p>While validating for null values is useful, checking the string length of a property would be even more useful. Here&rsquo;s the code to do this:</p><pre class="cs" language="csharp" customtypes="PropertyInfo ColumnAttribute ContextScope EntityValidator IEntityValidator LinqToSqlMaximumFieldLengthValidator LinqToSqlNullPropertyValidator VABEntityValidator  ValidationException ValidationFactory ValidationResult " customvaluetypes="PutYourCustomValueTypesHere">using System;<br />using System.Collections.Generic;<br />using System.Data.Linq.Mapping;<br />using System.Linq;<br />using System.Reflection;<br /><br />class LinqToSqlMaximumFieldLengthValidator : IEntityValidator<br />{<br />    public IEnumerable&lt;ValidationResult&gt; Validate(<br />        IEnumerable&lt;object&gt; entities)<br />    {<br />        return<br />            from entity in entities<br />            from result in GetMaxLengthErrorsFor(entity)<br />            select result;<br />    }<br /><br />    private static IEnumerable&lt;ValidationResult&gt;<br />        GetMaxLengthErrorsFor(object entity)<br />    {<br />        var properties = entity.GetType().GetProperties();<br /><br />        return<br />            from property in properties<br />            where property.PropertyType == typeof(string)<br />            let value = (string)property.GetValue(entity, null)<br />            let length = value == null ? 0 : value.Length<br />            where length &gt; 0<br />            let maximumLength = GetMaximumLength(property)<br />            where length &gt; maximumLength<br />            select BuildResult(entity, property, maximumLength);<br />    }<br /><br />    private static ValidationResult BuildResult(object entity,<br />        PropertyInfo property, int maximumLength)<br />    {<br />        const string FormatMessage =<br />            &quot;The length of the value must be less &quot; +<br />            &quot;or equal to {0} characters.&quot;;<br /><br />        string message =<br />            string.Format(FormatMessage, maximumLength);<br /><br />        return new ValidationResult(message, entity,<br />            property.Name, null, null);<br />    }<br /><br />    private static int GetMaximumLength(PropertyInfo property)<br />    {<br />        ColumnAttribute attribute =<br />            GetColumnAttribute(property);<br /><br />        if (attribute == null)<br />        {<br />            return Int32.MaxValue;<br />        }<br /><br />        string dbType = attribute.DbType;<br /><br />        if (!IsTruncatableTextType(dbType))<br />        {<br />            return Int32.MaxValue;<br />        }<br /><br />        int leftBracketIndex = dbType.IndexOf(&quot;(&quot;);<br />        int rightBracketIndex = dbType.IndexOf(&quot;)&quot;);<br /><br />        try<br />        {<br />            string length = dbType.Substring(leftBracketIndex + 1,<br />                rightBracketIndex - leftBracketIndex - 1);<br /><br />            return int.Parse(length);<br />        }<br />        catch (SystemException ex)<br />        {<br />            string message = string.Format(<br />                &quot;Property {0} of type {1} has a {2} defined &quot; +<br />                &quot;with a DbType with value '{3}'. The maximum &quot; +<br />                &quot;length of that text field can not be extracted.&quot;,<br />                property.Name, property.DeclaringType,<br />                typeof(ColumnAttribute), dbType);<br /><br />            throw new InvalidOperationException(message, ex);<br />        }<br />    }<br /><br />    private static ColumnAttribute GetColumnAttribute(<br />        PropertyInfo property)<br />    {<br />        object[] columnAttributes =<br />            property.GetCustomAttributes(typeof(ColumnAttribute), true);<br /><br />        if (columnAttributes.Length == 0)<br />        {<br />            return null;<br />        }<br /><br />        return ((ColumnAttribute)columnAttributes[0]);<br />    }<br /><br />    private static bool IsTruncatableTextType(string dbType)<br />    {<br />        StringComparison ignoreCase =<br />            StringComparison.InvariantCultureIgnoreCase;<br /><br />        return<br />            dbType != null &amp;&amp; (<br />            dbType.StartsWith(&quot;Char&quot;, ignoreCase) ||<br />            dbType.StartsWith(&quot;NChar&quot;, ignoreCase) ||<br />            dbType.StartsWith(&quot;VarChar&quot;, ignoreCase) ||<br />            dbType.StartsWith(&quot;NVarChar&quot;, ignoreCase));<br />    }<br />}</pre><p>This class is slightly more complicated than the previous one, but the concept is the same. The class iterates all supplied entities and for each entity iterates the entity's public string properties to check whether its value's length is longer than the maximum that is specified in the <span class="type">ColumnAttribute</span>. The <a rel="external" href="http://msdn.microsoft.com/en-us/library/system.data.linq.mapping.columnattribute.dbtype.aspx" title="MSDN - ColumnAttribute.DbType Property">DbType</a> property of the <span class="type">ColumnAttribute</span> specifies the length of the string. Problem here is that the <span class="code">DbType</span> property is a string and the maximum string length is buried within that string, which might be defined as: <font color="#a31515">&quot;NVarChar(15) NOT NULL&quot;</font>. That's why some dirty string splitting is going on.</p><p>Note that this is a bit naive implementation and it might be slow. I could imagine the class to cache the needed metadata to improve performance, but I leave this as an exercise for the reader.</p><p><font color="#ff0000">&lt;UPDATE 2010-01-31&gt;</font><br />I did some testing to compare the difference between the naive implementation and one that caches the metadata and I did this by validating 10.000 Employee entities (since Employee is the biggest entity in the Northwind domain). I measured an overhead of 0.5 ms per validated Employee entity on my dev box. This isn't that much, but a cached approach might be useful in situations where you validate large sets of entities.<br /><font color="#ff0000">&lt;/UPDATE&gt;</font><br /> </p><h6>Conclusion</h6><p>As you can see, after doing a bit refactoring, adding support for automatic validation according to the generated metadata is a breeze.</p><p>Happy validating.</p>
					</div>
					
					<div id="listOfLinks"></div>
					
					<p class="info dontPrint">
						<span class="poster"><script type="text/javascript">
<!--
	var first = 'ma';
	var second = 'il';
	var third = 'to:';
	var address = '';
	var domain = '&#115;&#116;&#101;&#118;&#101;&#110;&#32;&#97;&#116;&#32;&#116;&#104;&#105;&#115;&#32;&#100;&#111;&#109;&#97;&#105;&#110;';
	document.write('<a href="');
	document.write(first+second+third);
	document.write(address);
	document.write('&#64;');
	document.write(domain);
	document.write('" title="Email Steven">');
	document.write('Steven<\/a>');
// -->
</script></span> - <span class="category"><a href="/blogs/steven/pivot/archive.php?c=.NET_General">.NET General</a>, <a href="/blogs/steven/pivot/archive.php?c=6">C#</a>, <a href="/blogs/steven/pivot/archive.php?c=Enterprise_Library">Enterprise Library</a>, <a href="/blogs/steven/pivot/archive.php?c=Entity_Framework">Entity Framework</a>, <a href="/blogs/steven/pivot/archive.php?c=LINQ">LINQ</a>, <a href="/blogs/steven/pivot/archive.php?c=LINQ_to_SQL">LINQ to SQL</a>, <a href="/blogs/steven/pivot/archive.php?c=17">O/RM</a>, <a href="/blogs/steven/pivot/archive.php?c=Validation_Application_Block">Validation Application Block</a></span> - 
						<span class="comments"><a href="/blogs/steven/pivot/entry.php?id=64#comm" title="">No comments</a> /  <a href="/blogs/steven/pivot/entry.php?id=64#track" title="">No trackbacks</a></span> - 
						<a href="/blogs/steven/archives/archive_2009-m09.php#e64" title="Permanent link to 'Integrating Enterprise Library Validation Application Block With LINQ to SQL and Entity Framework Part 4: Using Metadata to Automate Validations' in the archives">&sect;</a> <a href="/blogs/steven/pivot/entry.php?id=64" title="Permanent link to entry 'Integrating Enterprise Library Validation Application Block With LINQ to SQL and Entity Framework Part 4: Using Metadata to Automate Validations'">&para;</a> 
					</p>
					
					<div id="NoJavascriptWarning">
						The code samples on my weblog are colorized using javascript, but
						you disabled javascript (for my website) on your browser. 
						If you're interested in viewing the posted code snippets in 
						color, please enable javascript.
					</div>
					<script type="text/javascript">
						var noScriptWarning = document.getElementById('NoJavascriptWarning');
						noScriptWarning.style.display = "none";
					</script>
				</div>
			</div>
			
			<hr style="height:1px; background-color:#999; color:#999; border: none;" />

			<p><b>No comments:</b></p>
			<div class="comments">
			<a id="comm"></a>

			</div>

		</div>

		<hr />
		
		<div id="footer">
			<p>&copy; 2007-2019 Steven van Deursen.<br /><span class="dontPrint"><a href="/blogs/steven/rss.xml" title="XML: RSS Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/rssbutton.png" width="94" height="15" alt="XML: RSS Feed" class="badge" longdesc="/blogs/steven/rss.xml" /></a> <a href="/blogs/steven/atom.xml" title="XML: Atom Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/atombutton.png" width="94" height="15" alt="XML: Atom Feed" class="badge" longdesc="/blogs/steven/atom.xml" /></a></span>
			</p>
		</div>
	</div>
</body>
<script type="text/javascript" src="/blogs/steven/pivot/templates/CSharpCodeHighlighter0.10.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/MSILCodeHighlighter0.1.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/X86CodeHighlighter0.1.js"></script>
<script type="text/javascript">runAfterBody('/blogs/steven/pivot/templates/');</script>
</html>