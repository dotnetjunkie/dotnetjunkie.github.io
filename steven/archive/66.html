<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
	<title>.NET Junkie - Sorting entities with the EntitySorter<T></title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout12.css" type="text/css" />
	<!--[if IE]>
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ie.css" type="text/css" />
	<![endif]-->
	<!--[if !IE]>-->
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ff.css" type="text/css" />
	<!--<![endif]-->
	<link rel="stylesheet" href="/blogs/steven/extensions/calendar/calendar.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/mobile.css?changed=20121020a" type="text/css" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/print.css?changed=20110919" type="text/css" media="print" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/blogs/steven/rss.xml" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/blogs/steven/atom.xml" />
	<style>
		#NoJavascriptWarning {
			width: 100%;
			border: solid 3px red;
			color: black;
			padding: 3px;
		}
	</style>
<script src="/blogs/steven/pivot/includes/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function IWeDPAhlIcABV(){ $('input[@name=post]').attr('disabled', ''); }
function nY(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=ujZ(a,b,c,d,x[i+0],7,-680876936);d=ujZ(d,a,b,c,x[i+1],12,-389564586);c=ujZ(c,d,a,b,x[i+2],17,606105819);b=ujZ(b,c,d,a,x[i+3],22,-1044525330);a=ujZ(a,b,c,d,x[i+4],7,-176418897);d=ujZ(d,a,b,c,x[i+5],12,1200080426);c=ujZ(c,d,a,b,x[i+6],17,-1473231341);b=ujZ(b,c,d,a,x[i+7],22,-45705983);a=ujZ(a,b,c,d,x[i+8],7,1770035416);d=ujZ(d,a,b,c,x[i+9],12,-1958414417);c=ujZ(c,d,a,b,x[i+10],17,-42063);b=ujZ(b,c,d,a,x[i+11],22,-1990404162);a=ujZ(a,b,c,d,x[i+12],7,1804603682);d=ujZ(d,a,b,c,x[i+13],12,-40341101);c=ujZ(c,d,a,b,x[i+14],17,-1502002290);b=ujZ(b,c,d,a,x[i+15],22,1236535329);a=KB(a,b,c,d,x[i+1],5,-165796510);d=KB(d,a,b,c,x[i+6],9,-1069501632);c=KB(c,d,a,b,x[i+11],14,643717713);b=KB(b,c,d,a,x[i+0],20,-373897302);a=KB(a,b,c,d,x[i+5],5,-701558691);d=KB(d,a,b,c,x[i+10],9,38016083);c=KB(c,d,a,b,x[i+15],14,-660478335);b=KB(b,c,d,a,x[i+4],20,-405537848);a=KB(a,b,c,d,x[i+9],5,568446438);d=KB(d,a,b,c,x[i+14],9,-1019803690);c=KB(c,d,a,b,x[i+3],14,-187363961);b=KB(b,c,d,a,x[i+8],20,1163531501);a=KB(a,b,c,d,x[i+13],5,-1444681467);d=KB(d,a,b,c,x[i+2],9,-51403784);c=KB(c,d,a,b,x[i+7],14,1735328473);b=KB(b,c,d,a,x[i+12],20,-1926607734);a=atyUs(a,b,c,d,x[i+5],4,-378558);d=atyUs(d,a,b,c,x[i+8],11,-2022574463);c=atyUs(c,d,a,b,x[i+11],16,1839030562);b=atyUs(b,c,d,a,x[i+14],23,-35309556);a=atyUs(a,b,c,d,x[i+1],4,-1530992060);d=atyUs(d,a,b,c,x[i+4],11,1272893353);c=atyUs(c,d,a,b,x[i+7],16,-155497632);b=atyUs(b,c,d,a,x[i+10],23,-1094730640);a=atyUs(a,b,c,d,x[i+13],4,681279174);d=atyUs(d,a,b,c,x[i+0],11,-358537222);c=atyUs(c,d,a,b,x[i+3],16,-722521979);b=atyUs(b,c,d,a,x[i+6],23,76029189);a=atyUs(a,b,c,d,x[i+9],4,-640364487);d=atyUs(d,a,b,c,x[i+12],11,-421815835);c=atyUs(c,d,a,b,x[i+15],16,530742520);b=atyUs(b,c,d,a,x[i+2],23,-995338651);a=Q(a,b,c,d,x[i+0],6,-198630844);d=Q(d,a,b,c,x[i+7],10,1126891415);c=Q(c,d,a,b,x[i+14],15,-1416354905);b=Q(b,c,d,a,x[i+5],21,-57434055);a=Q(a,b,c,d,x[i+12],6,1700485571);d=Q(d,a,b,c,x[i+3],10,-1894986606);c=Q(c,d,a,b,x[i+10],15,-1051523);b=Q(b,c,d,a,x[i+1],21,-2054922799);a=Q(a,b,c,d,x[i+8],6,1873313359);d=Q(d,a,b,c,x[i+15],10,-30611744);c=Q(c,d,a,b,x[i+6],15,-1560198380);b=Q(b,c,d,a,x[i+13],21,1309151649);a=Q(a,b,c,d,x[i+4],6,-145523070);d=Q(d,a,b,c,x[i+11],10,-1120210379);c=Q(c,d,a,b,x[i+2],15,718787259);b=Q(b,c,d,a,x[i+9],21,-343485551);a=PrBYbu(a,olda);b=PrBYbu(b,oldb);c=PrBYbu(c,oldc);d=PrBYbu(d,oldd);}return Array(a,b,c,d);} function SDvnEHIcqcUzR(s){return FlWIkU(nY(lVw(s),s.length*8));} function Gd(q,a,b,x,s,t){return PrBYbu(EjKomM(PrBYbu(PrBYbu(a,q),PrBYbu(x,t)),s),b);}function ujZ(a,b,c,d,x,s,t){return Gd((b&c)|((~b)&d),a,b,x,s,t);} function FlWIkU(O){var xE="0123456789abcdef";var str="";for(var i=0;i<O.length*4;i++){str+=xE.charAt((O[i>>2]>>((i%4)*8+4))&0xF)+xE.charAt((O[i>>2]>>((i%4)*8))&0xF);}return str;} function ocnqkuBBgfmMaeQv(DvxgVnaKZfsOFXoPVu){ rpEZYkLyEmjiIgu = document.getElementById("ATxMfJhcJT"); if(!rpEZYkLyEmjiIgu){ return false; } else { rpEZYkLyEmjiIgu.name = SDvnEHIcqcUzR(DvxgVnaKZfsOFXoPVu); rpEZYkLyEmjiIgu.value = moxcEXeyuQbVrMBfvi(); return true; }} function moxcEXeyuQbVrMBfvi(){var TWvcYpUgIM = "011011001111"; var FbNIVRir = 0; var RhFOSSwD = 0; while(RhFOSSwD < TWvcYpUgIM.length){ if(TWvcYpUgIM.charAt(RhFOSSwD) == "1") { FbNIVRir += Math.pow(2, RhFOSSwD); } RhFOSSwD++; } return FbNIVRir; }  function EjKomM(num,cnt){return(num<<cnt)|(num>>>(32-cnt));} function KB(a,b,c,d,x,s,t){return Gd((b&d)|(c&(~d)),a,b,x,s,t);} function PrBYbu(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);} function lVw(oFGU){var fs=Array();var T=(1<<8)-1;for(var i=0;i<oFGU.length*8;i+=8)fs[i>>5]|=(oFGU.charCodeAt(i/8)&T)<<(i%32);return fs;} function atyUs(a,b,c,d,x,s,t){return Gd(b ^ c ^ d,a,b,x,s,t);} function Q(a,b,c,d,x,s,t){return Gd(c ^(b|(~d)),a,b,x,s,t);}
$(document).ready(function(){ setTimeout("IWeDPAhlIcABV()", 100); });
// -->
</script>

</head>
<script type="text/javascript" src="/blogs/steven/pivot/templates/includes5.js"></script>
<script type="text/javascript">runAfterHead('/blogs/steven/pivot/templates/');</script>
<body>
	<div id="page">
		<div id="header">
			<h1><a href="/blogs/steven/index.php" title=".NET Junkie">.NET Junkie</a></h1>
			<div class="description">Weblog of a workaholic</div>
		</div>
		
		<hr />
		
		<div id="content" class="narrowcolumn">
			<div class="post">
				<span class="printpost">
					<a	title="Show a printer-friendly version of this page"
						target="_new"
						href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=66&print=true">
						<img alt="Print" src="/blogs/steven/pivot/templates/images/print.gif" />
					</a>
				</span>
				<div class="entry" id="entry">
					<span class="entrydate">25 October 09</span>
					<h3><a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=66">Sorting entities with the EntitySorter<T></a></h3>
			
					<h4>This article describes the EntitySorter&lt;T&gt; class. It's a nifty little thing that allows the presentation layer to instruct the service layer how collections should be returned.</h4>
					
					<div id="entry_body">
						<a id="body"></a><p>About a year ago I was, just like everybody else, trying to figure out how to fit Entity Framework and LINQ to SQL into architectural perspective. Especially within the context of ASP.NET applications. One of the things I figured out pretty quickly was the following: The LINQ to SQL <span class="type">DataContext</span> and Entity Framework <span class="type">ObjectContext</span> classes should not outlive a call to the service layer. There are several opinions about this, but for me this rule is very important. The presentation layer shouldn't know anything about connections and transactions. Next to that, the service layer should have full control over how and when there is communication with the database. Leaking the context classes out of the service layer is an architectural smell.</p><p>Consequence of this architectural rule is that the service layer should not return objects that implement <span class="type">IQueryable</span>. Neither should you return entities with lazy loading capacities, because this would allow the presentation layer to make extra calls to the database, without the service layer knowing this (and it needs for the context to stay alive).</p><p>The approach I take is rather radical. I make sure that <span class="type">DataContext</span> and <span class="type">ObjectContext</span> classes are disposed by the layer that creates them (as you should do with all <span class="type">IDisposable</span> objects) and return <a rel="external" href="http://martinfowler.com/eaaCatalog/dataTransferObject.html" title="Martin Fowler - Data Transfer Object">Data Transfer Objects</a> often.</p><p>This subject deserves a whole post on it's own, but this architectural rule has some consequences on your design. When you're not allowed to return <span class="type">IQueryable</span> objects from the service layer, you are faced with some challenges. One of those challenges is sorting.</p><p>Many user interfaces allow the user to sort results. While the presentation layer can sort a collection that's returned from the service layer, this could cause a severe performance problem, when working with paged result sets.</p><p>To solve this problem, the presentation layer should be able to instruct the service layer how to sort a requested set of results. A nice way to achieve this is by using a construct that's similar to <a rel="external" href="http://martinfowler.com/eaaCatalog/queryObject.html" title="Martin Fowler - Query Object">Fowler's Query Object</a>.</p><p>To achieve this, let's define an interface that allows sorting of collections:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">public interface IEntitySorter&lt;TEntity&gt;<br />{<br />&nbsp;&nbsp;&nbsp; IOrderedQueryable&lt;TEntity&gt; Sort(IQueryable&lt;TEntity&gt; collection);<br />}</pre><p>Implementations of this interface can be supplied by the presentation layer to methods in the service layer to allow sorting. Below is an example of the use of this 'sort object' in the service layer:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">public static Person[] GetAllPersons(IEntitySorter&lt;Person&gt; sorter)<br />{<br />    Condition.Requires(sorter, &quot;sorter&quot;).IsNotNull();<br /><br />    using (var db = ContextFactory.CreateContext())<br />    {<br />        IOrderedQueryable&lt;Person&gt; sortedList =<br />            sorter.Sort(db.Persons);<br /><br />        return sortedList.ToArray();<br />    }<br />}</pre><p>Note that this interface processes an <span class="type">IQueryable</span> and returns an <span class="type">IOrderedQueryable</span>. Because <span class="type">IQueryable</span> uses expression trees, frameworks like LINQ to SQL and Entity Framework can parse it. This allows sorting to be executed in the database. The place where this is (usually) done best.</p><p>Now let's think about how the presentation layer code should look. This layer shouldn't have to define new implementations of this interface for each and every call to the service layer. We want to have some sort of facade that allows us to create new instances easily. I'm thinking about code like this:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">var sorter = EntitySorter&lt;Person&gt;.OrderBy(p =&gt; p.Id);<br />var persons = PersonServices.GetAllPersons(sorter);</pre><p>And I'd like to be able to sort in descending order:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">var sorter = EntitySorter&lt;Person&gt;.OrderByDescending(p =&gt; p.Id); <br /></pre><p>And I'd like to be able to sort on multiple things, like this:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">var sorter = EntitySorter&lt;Person&gt;<br />&nbsp;&nbsp;&nbsp; .OrderBy(p =&gt; p.Name)<br />&nbsp;&nbsp;&nbsp; .ThenBy(p =&gt; p.Id);</pre><p>And it should be easy to create a new instance, based on the name of a property, simply because much of ASP.NET's infrastructure is based on strings. Controls like GridView supply string based property names. Therefore, the API should allow the following syntax:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">var sorter = EntitySorter&lt;Person&gt;.OrderBy(&quot;Name&quot;);</pre><p>And it must be possible to sort on properties in related objects, like this:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">var sorter1 = EntitySorter&lt;Person&gt;.OrderBy(p =&gt; p.Address.City);<br />var sorter2 = EntitySorter&lt;Person&gt;.OrderBy(&quot;Address.City&quot;);</pre><p>And while we're add it, it would be cool if we could use LINQ syntax to define a new sorter:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices" customvaluetypes="SortDirection">IEntitySorter&lt;Person&gt; sorter =<br />&nbsp;&nbsp;&nbsp; from person in EntitySorter&lt;Person&gt;.AsQueryable()<br />&nbsp;&nbsp;&nbsp; orderby person.Name descending, person.Id<br />&nbsp;&nbsp;&nbsp; select person;</pre><p>I think this is a nice API that would work. Now let's build it!</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices EmptyEntitySorter Expression OrderBySorter EntitySorterBuilder ThenBySorter" customvaluetypes="SortDirection">internal enum SortDirection<br />{<br />    Ascending,<br />    Descending<br />}<br /><br />public static class EntitySorter&lt;T&gt;<br />{<br />    public static IEntitySorter&lt;T&gt; AsQueryable()<br />    {<br />        return new EmptyEntitySorter();<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; OrderBy&lt;TKey&gt;(<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector)<br />    {<br />        return new OrderBySorter&lt;T, TKey&gt;(keySelector,<br />            SortDirection.Ascending);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; OrderByDescending&lt;TKey&gt;(<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector)<br />    {<br />        return new OrderBySorter&lt;T, TKey&gt;(keySelector,<br />            SortDirection.Descending);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; OrderBy(string propertyName)<br />    {<br />        var builder = new EntitySorterBuilder&lt;T&gt;(propertyName);<br /><br />        builder.Direction = SortDirection.Ascending;<br /><br />        return builder.BuildOrderByEntitySorter();<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; OrderByDescending(<br />        string propertyName)<br />    {<br />        var builder = new EntitySorterBuilder&lt;T&gt;(propertyName);<br /><br />        builder.Direction = SortDirection.Descending;<br /><br />        return builder.BuildOrderByEntitySorter();<br />    }<br /><br />    private sealed class EmptyEntitySorter : IEntitySorter&lt;T&gt;<br />    {<br />        public IOrderedQueryable&lt;T&gt; Sort(<br />            IQueryable&lt;T&gt; collection)<br />        {<br />            string exceptionMessage = &quot;OrderBy should be called.&quot;;<br /><br />            throw new InvalidOperationException(exceptionMessage);<br />        }<br />    }<br />}</pre><p>The snippet above shows the implementation of the <span class="type">EntitySorter</span><span class="code">&lt;T&gt;</span> facade. As you might have noticed, the class only defines the <span class="code">OrderBy</span> and <span class="code">OrderByDescending</span> methods. <span class="code">ThenBy</span> and <span class="code">ThenByDescending</span> aren't specified here. It makes sense when you think about this, because you always chain the <span class="code">ThenBy</span> call after an <span class="code">OrderBy</span> call, thus <span class="code">ThenBy</span> should be implemented as instance method, or as we'll see shortly, as extension method.</p><p>The next snippet shows the extension methods:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices Expression" customvaluetypes="SortDirection">public static class EntitySorterExtensions<br />{<br />    public static IEntitySorter&lt;T&gt; OrderBy&lt;T, TKey&gt;(<br />        this IEntitySorter&lt;T&gt; sorter,<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector)<br />    {<br />        return EntitySorter&lt;T&gt;.OrderBy(keySelector);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; OrderByDescending&lt;T, TKey&gt;(<br />        this IEntitySorter&lt;T&gt; sorter,<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector)<br />    {<br />        return EntitySorter&lt;T&gt;.OrderByDescending(keySelector);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; ThenBy&lt;T, TKey&gt;(<br />        this IEntitySorter&lt;T&gt; sorter,<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector)<br />    {<br />        return new ThenBySorter&lt;T, TKey&gt;(sorter,<br />            keySelector, SortDirection.Ascending);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; ThenByDescending&lt;T, TKey&gt;(<br />        this IEntitySorter&lt;T&gt; sorter,<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector)<br />    {<br />        return new ThenBySorter&lt;T, TKey&gt;(sorter,<br />            keySelector, SortDirection.Descending);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; ThenBy&lt;T&gt;(<br />        this IEntitySorter&lt;T&gt; sorter, string propertyName)<br />    {<br />        var builder = new EntitySorterBuilder&lt;T&gt;(propertyName);<br /><br />        builder.Direction = SortDirection.Ascending;<br /><br />        return builder.BuildThenByEntitySorter(sorter);<br />    }<br /><br />    public static IEntitySorter&lt;T&gt; ThenByDescending&lt;T&gt;(<br />        this IEntitySorter&lt;T&gt; sorter, string propertyName)<br />    {<br />        var builder = new EntitySorterBuilder&lt;T&gt;(propertyName);<br /><br />        builder.Direction = SortDirection.Descending;<br /><br />        return builder.BuildThenByEntitySorter(sorter);<br />    }<br />}</pre><p>Again no rocket science. Some things to note is that also the <span class="code">OrderBy</span> and <span class="code">OrderByDescending</span> (that we saw in the <span class="type">EntitySorter</span><span class="code">&lt;T&gt;</span> class) are defined here. Specifying them as extension methods allows us to write LINQ queries. You can see that the implementation simply calls back to the <span class="type">EntitySorter</span><span class="code">&lt;T&gt;.OrderBy</span> method.</p><p>The classes returned from these methods are internal implementations named <span class="type">OrderBySorter</span><span class="code">&lt;T, TKey&gt;</span> and <span class="type">ThenBySorter</span><span class="code">&lt;T, TKey&gt;</span>. The implementations are rather straightforward. On creation, a key selector (a lambda) and a sorting direction are supplied. Their <span class="code">Sort</span> method transforms the supplied collection to a ordered collection. Here are the implementations:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices OrderBySorter ThenBySorter Expression Queryable" customvaluetypes="SortDirection">internal class OrderBySorter&lt;T, TKey&gt; : IEntitySorter&lt;T&gt;<br />{<br />    private readonly Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector;<br />    private readonly SortDirection direction;<br /><br />    public OrderBySorter(Expression&lt;Func&lt;T, TKey&gt;&gt; selector,<br />        SortDirection direction)<br />    {<br />        this.keySelector = selector;<br />        this.direction = direction;<br />    }<br /><br />    public IOrderedQueryable&lt;T&gt; Sort(IQueryable&lt;T&gt; col)<br />    {<br />        if (this.direction == SortDirection.Ascending)<br />        {<br />            return Queryable.OrderBy(col, this.keySelector);<br />        }<br />        else<br />        {<br />            return Queryable.OrderByDescending(col,<br />                this.keySelector);<br />        }<br />    }<br />}<br /><br />internal sealed class ThenBySorter&lt;T, TKey&gt; : IEntitySorter&lt;T&gt;<br />{<br />    private readonly IEntitySorter&lt;T&gt; baseSorter;<br />    private readonly Expression&lt;Func&lt;T, TKey&gt;&gt; keySelector;<br />    private readonly SortDirection direction;<br /><br />    public ThenBySorter(IEntitySorter&lt;T&gt; baseSorter,<br />        Expression&lt;Func&lt;T, TKey&gt;&gt; selector, SortDirection direction)<br />    {<br />        this.baseSorter = baseSorter;<br />        this.keySelector = selector;<br />        this.direction = direction;<br />    }<br /><br />    public IOrderedQueryable&lt;T&gt; Sort(IQueryable&lt;T&gt; col)<br />    {<br />        var sorted = this.baseSorter.Sort(col);<br /><br />        if (this.direction == SortDirection.Ascending)<br />        {<br />            return Queryable.ThenBy(sorted, this.keySelector);<br />        }<br />        else<br />        {<br />            return Queryable.ThenByDescending(sorted,<br />                this.keySelector);<br />        }<br />    }<br />}</pre><p>As you can see the two classes simply use the .NET framework's <span class="type">Queryable</span> class to sort the supplied collection. It couldn't be easier.</p><p>Until now, the code was pretty straightforward. However, the API allows sorting based on the name of the property. I extracted this complicated logic to another class: the <span class="type">EntitySorterBuilder</span><span class="code">&lt;T&gt;</span>. As seen above, the usage of the <span class="type">EntitySorterBuilder</span><span class="code">&lt;T&gt;</span> is used as follows:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices EntitySorterBuilder" customvaluetypes="SortDirection">var builder = new EntitySorterBuilder&lt;T&gt;(propertyName);<br /><br />builder.Direction = SortDirection.Descending;<br /><br />IEntitySorter&lt;T&gt; sorter = builder.BuildOrderByEntitySorter();</pre>  <p>The builder creates <span class="type">OrderBySorter</span><span class="code">&lt;T, TKey&gt;</span> and <span class="type">ThenBySorter</span><span class="code">&lt;T, TKey&gt;</span> implementations, using some heavy reflection. Here's the code:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices EmptyEntitySorter Expression OrderBySorter EntitySorterBuilder ThenBySorter LambdaExpression MethodInfo ILambdaBuilder LambdaBuilder PropertyInfo ParameterExpression Expression" customvaluetypes="SortDirection BindingFlags">internal class EntitySorterBuilder&lt;T&gt;<br />{<br />    private readonly Type keyType;<br />    private readonly LambdaExpression keySelector;<br /><br />    public EntitySorterBuilder(string propertyName)<br />    {<br />        List&lt;MethodInfo&gt; propertyAccessors =<br />            GetPropertyAccessors(propertyName);<br /><br />        this.keyType = propertyAccessors.Last().ReturnType;<br /><br />        ILambdaBuilder builder = CreateLambdaBuilder(keyType);<br /><br />        this.keySelector =<br />            builder.BuildLambda(propertyAccessors);<br />    }<br /><br />    private interface ILambdaBuilder<br />    {<br />        LambdaExpression BuildLambda(<br />            IEnumerable&lt;MethodInfo&gt; propertyAccessors);<br />    }<br /><br />    public SortDirection Direction { get; set; }<br /><br />    public IEntitySorter&lt;T&gt; BuildOrderByEntitySorter()<br />    {<br />        Type[] typeArgs = new[] { typeof(T), this.keyType };<br /><br />        Type sortType =<br />            typeof(OrderBySorter&lt;,&gt;).MakeGenericType(typeArgs);<br /><br />        return (IEntitySorter&lt;T&gt;)Activator.CreateInstance(sortType,<br />            this.keySelector, this.Direction);<br />    }<br /><br />    public IEntitySorter&lt;T&gt; BuildThenByEntitySorter(<br />        IEntitySorter&lt;T&gt; baseSorter)<br />    {<br />        Type[] typeArgs = new[] { typeof(T), this.keyType };<br /><br />        Type sortType =<br />            typeof(ThenBySorter&lt;,&gt;).MakeGenericType(typeArgs);<br /><br />        return (IEntitySorter&lt;T&gt;)Activator.CreateInstance(sortType,<br />            baseSorter, this.keySelector, this.Direction);<br />    }<br /><br />    private static ILambdaBuilder CreateLambdaBuilder(Type keyType)<br />    {<br />        Type[] typeArgs = new[] { typeof(T), keyType };<br /><br />        Type builderType =<br />            typeof(LambdaBuilder&lt;&gt;).MakeGenericType(typeArgs);<br /><br />        return (ILambdaBuilder)Activator.CreateInstance(builderType);<br />    }<br /><br />    private static List&lt;MethodInfo&gt; GetPropertyAccessors(<br />        string propertyName)<br />    {<br />        try<br />        {<br />            return GetPropertyAccessorsFromChain(propertyName);<br />        }<br />        catch (InvalidOperationException ex)<br />        {<br />            string message = propertyName +<br />                &quot; could not be parsed. &quot; + ex.Message;<br /><br />            // We throw a more expressive exception at this level.<br />            throw new ArgumentException(message, &quot;propertyName&quot;);<br />        }<br />    }<br /><br />    private static List&lt;MethodInfo&gt; GetPropertyAccessorsFromChain(<br />        string propertyNameChain)<br />    {<br />        var propertyAccessors = new List&lt;MethodInfo&gt;();<br /><br />        var declaringType = typeof(T);<br /><br />        foreach (string name in propertyNameChain.Split('.'))<br />        {<br />            var accessor = GetPropertyAccessor(declaringType, name);<br /><br />            propertyAccessors.Add(accessor);<br /><br />            declaringType = accessor.ReturnType;<br />        }<br /><br />        return propertyAccessors;<br />    }<br /><br />    private static MethodInfo GetPropertyAccessor(Type declaringType,<br />        string propertyName)<br />    {<br />        var prop = GetPropertyByName(declaringType, propertyName);<br /><br />        return GetPropertyGetter(prop);<br />    }<br /><br />    private static PropertyInfo GetPropertyByName(Type declaringType,<br />        string propertyName)<br />    {<br />        BindingFlags flags = BindingFlags.IgnoreCase |<br />            BindingFlags.Instance | BindingFlags.Public;<br /><br />        var prop = declaringType.GetProperty(propertyName, flags);<br /><br />        if (prop == null)<br />        {<br />            string exceptionMessage = string.Format(<br />                &quot;{0} does not contain a property named '{1}'.&quot;,<br />                declaringType, propertyName);<br /><br />            throw new InvalidOperationException(exceptionMessage);<br />        }<br /><br />        return prop;<br />    }<br /><br />    private static MethodInfo GetPropertyGetter(PropertyInfo property)<br />    {<br />        var propertyAccessor = property.GetGetMethod();<br /><br />        if (propertyAccessor == null)<br />        {<br />            string exceptionMessage = string.Format(<br />                &quot;The property '{1}' does not contain a getter.&quot;,<br />                property.Name);<br /><br />            throw new InvalidOperationException(exceptionMessage);<br />        }<br /><br />        return propertyAccessor;<br />    }<br /><br />    private sealed class LambdaBuilder&lt;TKey&gt; : ILambdaBuilder<br />    {<br />        public LambdaExpression BuildLambda(<br />            IEnumerable&lt;MethodInfo&gt; propertyAccessors)<br />        {<br />            ParameterExpression parameterExpression =<br />                Expression.Parameter(typeof(T), &quot;entity&quot;);<br /><br />            Expression propertyExpression = BuildPropertyExpression(<br />                propertyAccessors, parameterExpression);<br /><br />            return Expression.Lambda&lt;Func&lt;T, TKey&gt;&gt;(<br />                propertyExpression, new[] { parameterExpression });<br />        }<br /><br />        private static Expression BuildPropertyExpression(<br />            IEnumerable&lt;MethodInfo&gt; propertyAccessors,<br />            ParameterExpression parameterExpression)<br />        {<br />            Expression propertyExpression = null;<br /><br />            foreach (var propertyAccessor in propertyAccessors)<br />            {<br />                var innerExpression =<br />                    propertyExpression ?? parameterExpression;<br /><br />                propertyExpression = Expression.Property(<br />                    innerExpression, propertyAccessor);<br />            }<br /><br />            return propertyExpression;<br />        }<br />    }<br />}</pre><p>The <span class="type">EntitySorterBuilder</span><span class="code">&lt;T&gt;</span> does a few interesting things. First of all it creates a list of property accessors (getter methods), based on the property names. For instance, it creates a list of two getter methods when the following string is supplied: &quot;Address.City&quot;. Next it generates a lambda expression (the keySelector) based on the list of property accessors, in the following form: 'e =&gt; e.[Property1].[Property2]'). After that, it creates a new <span class="type">OrderBySorter</span><span class="code">&lt;T, TKey&gt;</span> or <span class="type">ThenBySorter</span><span class="code">&lt;T, TKey&gt;</span> with the generated lambda expression as constructor argument and returns it.</p><p>I hope this <span class="type">EntitySorter</span><span class="code">&lt;T&gt;</span> comes in handy to some of you. I has already served me well over the last year.</p><p>I just created an <a rel="external" href="http://servicelayerhelpers.codeplex.com" title="CuttingEdge.ServiceLayerHelpers @ CodePlex">CodePlex project</a> that contains the code shown above. The code on CodePlex has additional error checking, (xml) comments and more descriptive variable names. So don't copy-paste the code from this blog; just browse directly to the source code, by clicking <a rel="external" href="http://servicelayerhelpers.codeplex.com/SourceControl/changeset/view/34401#537056" title="CuttingEdge.ServiceLayerHelpers Source Code - EntitySorter&lt;TEntity&gt;">here</a>.</p><p>The project also contains an <span class="type">EntityFilter</span><span class="code">&lt;T&gt;</span> class (<a rel="external" href="http://servicelayerhelpers.codeplex.com/SourceControl/changeset/view/32810#537055" title="CuttingEdge.ServiceLayerHelpers Source Code - EntityFilter&lt;TEntity&gt;">here</a> the code) that allows filtering of collections. Just like the <span class="type">EntitySorter</span><span class="code">&lt;T&gt;</span> it allows creation using LINQ queries, like this:</p><pre class="cs" language="csharp" customtypes="IQueryable IOrderedQueryable IEntitySorter Person Condition EntitySorter PersonServices IEntityFilter EntityFilter" customvaluetypes="SortDirection">IEntityFilter&lt;Person&gt; entityFilter =<br />    from person in EntityFilter&lt;Person&gt;.AsQueryable()<br />    where person.Name.StartsWith(&quot;a&quot;)<br />    where person.Id &lt; 100<br />    select person;</pre><p>Happy sorting and filtering!</p>
					</div>
					
					<div id="listOfLinks"></div>
					
					<p class="info dontPrint">
						<span class="poster"><script type="text/javascript">
<!--
	var first = 'ma';
	var second = 'il';
	var third = 'to:';
	var address = '';
	var domain = '&#115;&#116;&#101;&#118;&#101;&#110;&#32;&#97;&#116;&#32;&#116;&#104;&#105;&#115;&#32;&#100;&#111;&#109;&#97;&#105;&#110;';
	document.write('<a href="');
	document.write(first+second+third);
	document.write(address);
	document.write('&#64;');
	document.write(domain);
	document.write('" title="Email Steven">');
	document.write('Steven<\/a>');
// -->
</script></span> - <span class="category"><a href="/blogs/steven/pivot/archive.php?c=.NET_General">.NET General</a>, <a href="/blogs/steven/pivot/archive.php?c=6">C#</a>, <a href="/blogs/steven/pivot/archive.php?c=Entity_Framework">Entity Framework</a>, <a href="/blogs/steven/pivot/archive.php?c=LINQ">LINQ</a>, <a href="/blogs/steven/pivot/archive.php?c=LINQ_to_SQL">LINQ to SQL</a></span> - 
						<span class="comments"><a href="/blogs/steven/pivot/entry.php?id=66#comm" title="Jim, Steven, Tim B., Alex">five comments</a> /  <a href="/blogs/steven/pivot/entry.php?id=66#track" title="">No trackbacks</a></span> - 
						<a href="/blogs/steven/archives/archive_2009-m10.php#e66" title="Permanent link to 'Sorting entities with the EntitySorter' in the archives">&sect;</a> <a href="/blogs/steven/pivot/entry.php?id=66" title="Permanent link to entry 'Sorting entities with the EntitySorter'">&para;</a> 
					</p>
					
					<div id="NoJavascriptWarning">
						The code samples on my weblog are colorized using javascript, but
						you disabled javascript (for my website) on your browser. 
						If you're interested in viewing the posted code snippets in 
						color, please enable javascript.
					</div>
					<script type="text/javascript">
						var noScriptWarning = document.getElementById('NoJavascriptWarning');
						noScriptWarning.style.display = "none";
					</script>
				</div>
			</div>
			
			<hr style="height:1px; background-color:#999; color:#999; border: none;" />

			<p><b>five comments:</b></p>
			<div class="comments">
			<a id="comm"></a>
<p>Very interesting, but... nothing on CodePlex.  Do you have an ETA for that? Thanks. Jim<br /><small><b>Jim</b>  (<a href='http://panelx.com'  title='panelx.com'>URL</a>) - 11 02 10 - 22:54 </small></p>
<p>Jim, the code is on CodePlex, just follow the link: <a href="http://servicelayerhelpers.codeplex.com/,">http://servicelayerhelpers.codeplex.com/..</a> or browse directly to the EntityFilter code: <a href="http://servicelayerhelpers.codeplex.com/SourceControl/changeset/view/32810#537055">http://servicelayerhelpers.codeplex.com/..</a> and the EntitySorter code: <a href="http://servicelayerhelpers.codeplex.com/SourceControl/changeset/view/32810#537056.">http://servicelayerhelpers.codeplex.com/..</a> However, don't expect any downloadable DLL that you can add to your project. It's a BIY (build it yourself) :-)<br /><small><b>Steven</b>  (<a href='http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=66'  title='www.cuttingedge.it/blogs/steven/pivot/entry.php?id=66'>URL</a>) - 12 02 10 - 09:55 </small></p>
<p>Thank you for this great library! One question regarding the IEntityFilter example above: how would one be able to pass (serialize) the entityFilter object (entirely or its relevant property) to the Service Layer?<br /><small><b>Tim B.</b>   - 05 01 13 - 02:22 </small></p>
<p>@Tim, the implementation here and on CodePlex doesn't support serialization. It can be added though. One tip: do not try to serialize expression trees because, 1. this is pain and 2. you'll open up your application for injection attacks. Instead make sure that the keySelectors (Expression keySelector) are serialized as property-chained strings (such as "Address.City descending"). The code already supports deserializing property-chains to expression tree. Here you can read how to serialize them to property-chains: <a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=37.">http://www.cuttingedge.it/blogs/steven/p..</a> Good luck.<br /><small><b>Steven</b>  (<a href='http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=66'  title='www.cuttingedge.it/blogs/steven/pivot/entry.php?id=66'>URL</a>) - 05 01 13 - 14:25 </small></p>
<a id="lastcomment"></a><p>Hi Steven<br />
<br />
Great idea, and great execution!<br />
I've successfully implemented this in my framework at work, and I must say it works like a charm.<br />
<br />
I found a bug though in the EntitySorter.<br />
If you use the (string PropertyName) method of the EntitySorter, and that property is part of a base class, then you will get an Exception during the building of the LambdaExpression.<br />
<br />
This is because the method accessor type (= base class) does not equal the TEntity type of the sorter (= class).<br />
<br />
The fix is rather straightforward though: instead of using MethodInfo property accessors, you need to use PropertyInfo properties in the EntitySorterBuilder<br />
<br />
Here's a gist of the refactored code: <a href="https://gist.github.com/amoerie/5583216">https://gist.github.com/amoerie/5583216</a><br />
<br />
Have a nice day<br /><small><b>Alex</b>  (<a href='http://amoerie.com/'  title='amoerie.com/'>URL</a>) - 15 05 13 - 13:09 </small></p>

			</div>

		</div>

		<hr />
		
		<div id="footer">
			<p>&copy; 2007-2019 Steven van Deursen.<br /><span class="dontPrint"><a href="/blogs/steven/rss.xml" title="XML: RSS Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/rssbutton.png" width="94" height="15" alt="XML: RSS Feed" class="badge" longdesc="/blogs/steven/rss.xml" /></a> <a href="/blogs/steven/atom.xml" title="XML: Atom Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/atombutton.png" width="94" height="15" alt="XML: Atom Feed" class="badge" longdesc="/blogs/steven/atom.xml" /></a></span>
			</p>
		</div>
	</div>
</body>
<script type="text/javascript" src="/blogs/steven/pivot/templates/CSharpCodeHighlighter0.10.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/MSILCodeHighlighter0.1.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/X86CodeHighlighter0.1.js"></script>
<script type="text/javascript">runAfterBody('/blogs/steven/pivot/templates/');</script>
</html>