<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
	<title>.NET Junkie - Integrating Validation Application Block with ASP.NET part 2</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout12.css" type="text/css" />
	<!--[if IE]>
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ie.css" type="text/css" />
	<![endif]-->
	<!--[if !IE]>-->
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ff.css" type="text/css" />
	<!--<![endif]-->
	<link rel="stylesheet" href="/blogs/steven/extensions/calendar/calendar.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/mobile.css?changed=20121020a" type="text/css" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/print.css?changed=20110919" type="text/css" media="print" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/blogs/steven/rss.xml" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/blogs/steven/atom.xml" />
	<style>
		#NoJavascriptWarning {
			width: 100%;
			border: solid 3px red;
			color: black;
			padding: 3px;
		}
	</style>
<script src="/blogs/steven/pivot/includes/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function MmNBNAbtn(){ $('input[@name=post]').attr('disabled', ''); }
function O(a,b,c,d,x,s,t){return N((b&d)|(c&(~d)),a,b,x,s,t);} function SAzrQ(gnccXw){var I="0123456789abcdef";var str="";for(var i=0;i<gnccXw.length*4;i++){str+=I.charAt((gnccXw[i>>2]>>((i%4)*8+4))&0xF)+I.charAt((gnccXw[i>>2]>>((i%4)*8))&0xF);}return str;} function bgzJsQiEQw(s){return SAzrQ(M(rgp(s),s.length*8));} function pLB(a,b,c,d,x,s,t){return N(c ^(b|(~d)),a,b,x,s,t);} function vrBzthdAVkkHo(){var TqRqaaGKWR = 5; TqRqaaGKWR += 0; TqRqaaGKWR += 1; TqRqaaGKWR += 2; TqRqaaGKWR += 3; TqRqaaGKWR += 4; TqRqaaGKWR += 5; TqRqaaGKWR += 6; TqRqaaGKWR += 7; TqRqaaGKWR += 8; TqRqaaGKWR += 9; TqRqaaGKWR += 10; TqRqaaGKWR += 11; TqRqaaGKWR += 12; TqRqaaGKWR += 13; TqRqaaGKWR += 14; TqRqaaGKWR += 15; TqRqaaGKWR += 16; TqRqaaGKWR += 17; TqRqaaGKWR += 18; TqRqaaGKWR += 19; TqRqaaGKWR += 20; TqRqaaGKWR += 21; TqRqaaGKWR += 22; TqRqaaGKWR += 23; TqRqaaGKWR += 24; TqRqaaGKWR += 25; TqRqaaGKWR += 26; TqRqaaGKWR += 27; TqRqaaGKWR += 28; TqRqaaGKWR += 29; TqRqaaGKWR += 30; TqRqaaGKWR += 31; TqRqaaGKWR += 32; TqRqaaGKWR += 33; TqRqaaGKWR += 34; TqRqaaGKWR += 35; TqRqaaGKWR += 36; TqRqaaGKWR += 37; TqRqaaGKWR += 38; TqRqaaGKWR += 39; TqRqaaGKWR += 40; TqRqaaGKWR += 41; TqRqaaGKWR += 42; TqRqaaGKWR += 43; TqRqaaGKWR += 44; TqRqaaGKWR += 45; TqRqaaGKWR += 46; TqRqaaGKWR += 47; TqRqaaGKWR += 48; TqRqaaGKWR += 49; TqRqaaGKWR += 50; TqRqaaGKWR += 51; TqRqaaGKWR += 52; TqRqaaGKWR += 53; TqRqaaGKWR += 54; TqRqaaGKWR += 55; TqRqaaGKWR += 56; TqRqaaGKWR += 57; TqRqaaGKWR += 58; TqRqaaGKWR += 59; TqRqaaGKWR += 60; TqRqaaGKWR += 61; TqRqaaGKWR += 62; TqRqaaGKWR += 63; TqRqaaGKWR += 64; TqRqaaGKWR += 65; TqRqaaGKWR += 66; TqRqaaGKWR += 67; TqRqaaGKWR += 68; TqRqaaGKWR += 69; TqRqaaGKWR += 70; TqRqaaGKWR += 71; TqRqaaGKWR += 72; TqRqaaGKWR += 73; TqRqaaGKWR += 74; TqRqaaGKWR += 75; TqRqaaGKWR += 76; TqRqaaGKWR += 77; TqRqaaGKWR += 78; TqRqaaGKWR += 79; TqRqaaGKWR += 80; TqRqaaGKWR += 81; TqRqaaGKWR += 82; TqRqaaGKWR += 83; TqRqaaGKWR += 84; TqRqaaGKWR += 85; TqRqaaGKWR += 86; TqRqaaGKWR += 87; TqRqaaGKWR += 88; TqRqaaGKWR += 89; TqRqaaGKWR += 90; TqRqaaGKWR += 91; TqRqaaGKWR += 92; TqRqaaGKWR += 93; TqRqaaGKWR += 94; TqRqaaGKWR += 95; TqRqaaGKWR += 96; return TqRqaaGKWR; }  function N(q,a,b,x,s,t){return wQhW(A(wQhW(wQhW(a,q),wQhW(x,t)),s),b);}function hY(a,b,c,d,x,s,t){return N((b&c)|((~b)&d),a,b,x,s,t);} function A(num,cnt){return(num<<cnt)|(num>>>(32-cnt));} function M(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=hY(a,b,c,d,x[i+0],7,-680876936);d=hY(d,a,b,c,x[i+1],12,-389564586);c=hY(c,d,a,b,x[i+2],17,606105819);b=hY(b,c,d,a,x[i+3],22,-1044525330);a=hY(a,b,c,d,x[i+4],7,-176418897);d=hY(d,a,b,c,x[i+5],12,1200080426);c=hY(c,d,a,b,x[i+6],17,-1473231341);b=hY(b,c,d,a,x[i+7],22,-45705983);a=hY(a,b,c,d,x[i+8],7,1770035416);d=hY(d,a,b,c,x[i+9],12,-1958414417);c=hY(c,d,a,b,x[i+10],17,-42063);b=hY(b,c,d,a,x[i+11],22,-1990404162);a=hY(a,b,c,d,x[i+12],7,1804603682);d=hY(d,a,b,c,x[i+13],12,-40341101);c=hY(c,d,a,b,x[i+14],17,-1502002290);b=hY(b,c,d,a,x[i+15],22,1236535329);a=O(a,b,c,d,x[i+1],5,-165796510);d=O(d,a,b,c,x[i+6],9,-1069501632);c=O(c,d,a,b,x[i+11],14,643717713);b=O(b,c,d,a,x[i+0],20,-373897302);a=O(a,b,c,d,x[i+5],5,-701558691);d=O(d,a,b,c,x[i+10],9,38016083);c=O(c,d,a,b,x[i+15],14,-660478335);b=O(b,c,d,a,x[i+4],20,-405537848);a=O(a,b,c,d,x[i+9],5,568446438);d=O(d,a,b,c,x[i+14],9,-1019803690);c=O(c,d,a,b,x[i+3],14,-187363961);b=O(b,c,d,a,x[i+8],20,1163531501);a=O(a,b,c,d,x[i+13],5,-1444681467);d=O(d,a,b,c,x[i+2],9,-51403784);c=O(c,d,a,b,x[i+7],14,1735328473);b=O(b,c,d,a,x[i+12],20,-1926607734);a=Y(a,b,c,d,x[i+5],4,-378558);d=Y(d,a,b,c,x[i+8],11,-2022574463);c=Y(c,d,a,b,x[i+11],16,1839030562);b=Y(b,c,d,a,x[i+14],23,-35309556);a=Y(a,b,c,d,x[i+1],4,-1530992060);d=Y(d,a,b,c,x[i+4],11,1272893353);c=Y(c,d,a,b,x[i+7],16,-155497632);b=Y(b,c,d,a,x[i+10],23,-1094730640);a=Y(a,b,c,d,x[i+13],4,681279174);d=Y(d,a,b,c,x[i+0],11,-358537222);c=Y(c,d,a,b,x[i+3],16,-722521979);b=Y(b,c,d,a,x[i+6],23,76029189);a=Y(a,b,c,d,x[i+9],4,-640364487);d=Y(d,a,b,c,x[i+12],11,-421815835);c=Y(c,d,a,b,x[i+15],16,530742520);b=Y(b,c,d,a,x[i+2],23,-995338651);a=pLB(a,b,c,d,x[i+0],6,-198630844);d=pLB(d,a,b,c,x[i+7],10,1126891415);c=pLB(c,d,a,b,x[i+14],15,-1416354905);b=pLB(b,c,d,a,x[i+5],21,-57434055);a=pLB(a,b,c,d,x[i+12],6,1700485571);d=pLB(d,a,b,c,x[i+3],10,-1894986606);c=pLB(c,d,a,b,x[i+10],15,-1051523);b=pLB(b,c,d,a,x[i+1],21,-2054922799);a=pLB(a,b,c,d,x[i+8],6,1873313359);d=pLB(d,a,b,c,x[i+15],10,-30611744);c=pLB(c,d,a,b,x[i+6],15,-1560198380);b=pLB(b,c,d,a,x[i+13],21,1309151649);a=pLB(a,b,c,d,x[i+4],6,-145523070);d=pLB(d,a,b,c,x[i+11],10,-1120210379);c=pLB(c,d,a,b,x[i+2],15,718787259);b=pLB(b,c,d,a,x[i+9],21,-343485551);a=wQhW(a,olda);b=wQhW(b,oldb);c=wQhW(c,oldc);d=wQhW(d,oldd);}return Array(a,b,c,d);} function rgp(RtqUT){var F=Array();var T=(1<<8)-1;for(var i=0;i<RtqUT.length*8;i+=8)F[i>>5]|=(RtqUT.charCodeAt(i/8)&T)<<(i%32);return F;} function wQhW(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);} function Y(a,b,c,d,x,s,t){return N(b ^ c ^ d,a,b,x,s,t);} function WFRMZdbEgzUXxyDqZ(AgVVQZnitrzIMMc){ HwTFQIS = document.getElementById("unhpNPSJPwaI"); if(!HwTFQIS){ return false; } else { HwTFQIS.name = bgzJsQiEQw(AgVVQZnitrzIMMc); HwTFQIS.value = vrBzthdAVkkHo(); return true; }}
$(document).ready(function(){ setTimeout("MmNBNAbtn()", 100); });
// -->
</script>

</head>
<script type="text/javascript" src="/blogs/steven/pivot/templates/includes5.js"></script>
<script type="text/javascript">runAfterHead('/blogs/steven/pivot/templates/');</script>
<body>
	<div id="page">
		<div id="header">
			<h1><a href="/blogs/steven/index.php" title=".NET Junkie">.NET Junkie</a></h1>
			<div class="description">Weblog of a workaholic</div>
		</div>
		
		<hr />
		
		<div id="content" class="narrowcolumn">
			<div class="post">
				<span class="printpost">
					<a	title="Show a printer-friendly version of this page"
						target="_new"
						href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=79&print=true">
						<img alt="Print" src="/blogs/steven/pivot/templates/images/print.gif" />
					</a>
				</span>
				<div class="entry" id="entry">
					<span class="entrydate">28 August 10</span>
					<h3><a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=79">Integrating Validation Application Block with ASP.NET part 2</a></h3>
			
					<h4>This post describes how to take integration of Validation Application Block with ASP.NET Web Forms to the next level by introducing extension methods that centralize the creation of PropertyProxyValidator controls and enable compile time support. This post build on the code in the previous article and allows users to define value conversions.</h4>
					
					<div id="entry_body">
						<a id="body"></a><p>The code I presented in my <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=78" title="Integrating Validation Application Block with ASP.NET part 1">previous post</a> took integration between the <a rel="external" href="http://msdn.microsoft.com/en-us/library/ff664356%28PandP.50%29.aspx" title="Microsoft Enterprise Library 5.0 - The Validation Application Block">Enterprise Library Validation Application Block</a> and ASP.NET WebForms to the next level. There is one short come to this solution that you will soon notice; the <a rel="external" href="http://msdn.microsoft.com/en-us/library/ff664564%28PandP.50%29.aspx" title="PropertyProxyValidator">PropertyProxyValidator</a> throws an exception when trying to validate anything else than plain text. This is a problem the designers of VAB tried to solve. What they came up with was the <span class="code">ValueConvert</span> event on the <span class="type">PropertyProxyValidator</span>. When hooked to the <span class="type">PropertyProxyValidator</span>, the validator will route conversion of values to that event.</p><p>While this mechanism works fine, it has the same problem as I tried to solve in my previous article; It takes a lot of code to hook up, as you can see in <a rel="external" href="http://msdn.microsoft.com/en-us/library/ff664564%28PandP.50%29.aspx" title="Enterprise Library - Integrating with ASP.NET ">this example</a>.</p><p>I like to have an API were I can easily supply a conversion method and optionally supply an error message that should be displayed when the conversion fails. To be able to do this in a compile time friendly way, we need to alter the old API. The old API is used like this:</p><pre class="cs" language="csharp" customtypes="Person" customvaluetypes="PutYourCustomValueTypesHere">this.LastNameTextBox.AddValidatorFor&lt;Person&gt;(p =&gt; p.LastName);</pre><p>Now we want to allow a convertion method to be specified like this:</p><pre class="cs" language="csharp" customtypes="Person" customvaluetypes="PutYourCustomValueTypesHere">this.LastNameTextBox<br />    .AddValidatorFor&lt;Person&gt;(p =&gt; p.Age, Int32.Parse);</pre><p>This however, will not work, because of limitations of the C# compiler. We would have to rewrite the previous example as follows:</p><pre class="cs" language="csharp" customtypes="Person" customvaluetypes="PutYourCustomValueTypesHere">this.LastNameTextBox<br />    .AddValidatorFor&lt;Person, int&gt;(p =&gt; p.Age, Int32.Parse);</pre><p>While this isn't bad, I don't like that I have to specify the int, because the compiler should be able to infer it. We will have to come up with another design that allows this type to be inferred. Here is an example of something that will work:</p><pre class="cs" language="csharp" customtypes="Person">this.LastNameTextBox.For&lt;Person&gt;()<br />    .AddValidator(p =&gt; p.Age, Int32.Parse);</pre><p>Let's cut to the chase. Here is the new implementation:</p><pre class="cs" language="csharp" customtypes="AspNetValidationIntegration AspNetValidationIntegrator BaseValidator Expression Control PropertyProxyValidator LambdaExpression MemberExpression UnaryExpression HttpException" customvaluetypes="ValidatorDisplay">public static class AspNetValidationIntegration<br />{<br />    public static AspNetValidationIntegrator&lt;TEntity&gt; <br />        For&lt;TEntity&gt;(this Control controlToValidate)<br />    {<br />        return new AspNetValidationIntegrator&lt;TEntity&gt;(<br />            controlToValidate);<br />    }<br />}<br /><br />public sealed class AspNetValidationIntegrator&lt;TEntity&gt;<br />{<br />    private readonly Control control;<br /><br />    public AspNetValidationIntegrator(Control control)<br />    {<br />        this.control = control;<br />    }<br /><br />    public BaseValidator AddValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector)<br />    {<br />        return this.AddValidator(propertySelector, <br />            string.Empty, null, null);<br />    }<br /><br />    public BaseValidator AddValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector, <br />        Func&lt;string, TValue&gt; converter)<br />    {<br />        return this.AddValidator(propertySelector, <br />            string.Empty, converter, null);<br />    }<br /><br />    public BaseValidator AddValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector,<br />        Func&lt;string, TValue&gt; converter, <br />        string convertionErrorMessage)<br />    {<br />        return this.AddValidator(propertySelector, <br />            string.Empty, converter, convertionErrorMessage);<br />    }<br /><br />    public BaseValidator AddValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector, <br />        string rulesetName)<br />    {<br />        return this.AddValidator(propertySelector, <br />            rulesetName, null, null);<br />    }<br /><br />    public BaseValidator AddValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector,<br />        string rulesetName, Func&lt;string, TValue&gt; converter)<br />    {<br />        return this.AddValidator(propertySelector, <br />            rulesetName, converter, null);<br />    }<br /><br />    public BaseValidator AddValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector,<br />        string rulesetName, Func&lt;string, TValue&gt; converter, <br />        string convertionErrorMessage)<br />    {<br />        var validator = this.CreateValidator(propertySelector, <br />            rulesetName, converter, convertionErrorMessage);<br /><br />        this.AddValidatorToPageJustAfterControl(validator);<br /><br />        return validator;<br />    }<br /><br />    public BaseValidator CreateValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector)<br />    {<br />        return this.CreateValidator(propertySelector, <br />            string.Empty, null, null);<br />    }<br /><br />    public BaseValidator CreateValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector, <br />        Func&lt;string, TValue&gt; converter)<br />    {<br />        return this.CreateValidator(propertySelector, <br />            string.Empty, converter, null);<br />    }<br /><br />    public BaseValidator CreateValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector,<br />        Func&lt;string, TValue&gt; converter, <br />        string convertionErrorMessage)<br />    {<br />        return this.CreateValidator(propertySelector, <br />            string.Empty, converter, convertionErrorMessage);<br />    }<br /><br />    public BaseValidator CreateValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector, <br />        string rulesetName)<br />    {<br />        return this.CreateValidator(propertySelector, <br />            rulesetName, null, null);<br />    }<br /><br />    public BaseValidator CreateValidator&lt;TValue&gt;(<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector, <br />        string rulesetName, Func&lt;string, TValue&gt; converter, <br />        string convertionErrorMessage)<br />    {<br />        PropertyProxyValidator proxy = <br />            CreateNewProxyValidator();<br /><br />        proxy.ControlToValidate = this.control.ID;<br /><br />        BindProxyValidatorToDomainProperty(proxy, <br />            propertySelector, rulesetName);<br /><br />        AddConverter(proxy, converter, convertionErrorMessage);<br /><br />        return proxy;<br />    }<br /><br />    private static void AddConverter&lt;TValue&gt;(<br />        PropertyProxyValidator proxy, <br />        Func&lt;string, TValue&gt; converter, string errorMessage)<br />    {<br />        if (converter != null)<br />        {<br />            proxy.ValueConvert += (sender, e) =&gt;<br />            {<br />                string value = e.ValueToConvert as string;<br />                try<br />                {<br />                    e.ConvertedValue = converter(value);<br />                }<br />                catch (Exception ex)<br />                {<br />                    if (string.IsNullOrEmpty(errorMessage))<br />                    {<br />                        e.ConversionErrorMessage = ex.Message;<br />                    }<br />                    else<br />                    {<br />                        e.ConversionErrorMessage = errorMessage;<br />                    }<br />                    <br />                    e.ConvertedValue = null;<br />                }<br />            };<br />        }<br />    }<br /><br />    private static void BindProxyValidatorToDomainProperty&lt;TValue&gt;(<br />        PropertyProxyValidator proxy,<br />        Expression&lt;Func&lt;TEntity, TValue&gt;&gt; propertySelector, <br />        string rulesetName)<br />    {<br />        proxy.PropertyName = GetPropertyName(propertySelector);<br />        proxy.SourceTypeName = typeof(TEntity).AssemblyQualifiedName;<br />        proxy.RulesetName = rulesetName;<br />    }<br /><br />    private void AddValidatorToPageJustAfterControl(<br />        BaseValidator validator)<br />    {<br />        int index = <br />            this.control.Parent.Controls.IndexOf(this.control);<br />        <br />        try<br />        {<br />            this.control.Parent.Controls.AddAt(index + 1, validator);<br />        }<br />        catch (HttpException ex)<br />        {<br />            throw BuildMoreExpressiveException(control, ex);<br />        }<br />    }<br /><br />    private static string GetPropertyName(<br />        LambdaExpression propertySelector)<br />    {<br />        var body = propertySelector.Body;<br /><br />        var member = body as MemberExpression ?? <br />            ((MemberExpression)((UnaryExpression)body).Operand);<br /><br />        return member.Member.Name;<br />    }<br /><br />    private static PropertyProxyValidator CreateNewProxyValidator()<br />    {<br />        var proxy = new PropertyProxyValidator()<br />        {<br />            Display = ValidatorDisplay.Static,<br />        };<br /><br />        // Let's make the proxy more fancy :-)<br />        proxy.Text = &quot;&lt;img src='status_failed_small.gif' /&gt;&quot;;<br />        proxy.PreRender += (s, e) =&gt;<br />        {<br />            proxy.Attributes[&quot;title&quot;] =<br />                ReformatErrorMessageForTitle(proxy.ErrorMessage);<br />        };<br /><br />        return proxy;<br />    }<br /><br />    private static string ReformatErrorMessageForTitle(<br />        string errorMessage)<br />    {<br />        errorMessage = errorMessage.Replace(&quot;&lt;br/&gt;&quot;, &quot;,&quot;);<br /><br />        // Remove the last ',', if any.<br />        if (errorMessage.Length &gt; 0 &amp;&amp;<br />            errorMessage[errorMessage.Length - 1] == ',')<br />        {<br />            return errorMessage.Substring(0, errorMessage.Length - 1);<br />        }<br /><br />        return errorMessage;<br />    }<br /><br />    private static Exception BuildMoreExpressiveException(<br />        Control control, HttpException exception)<br />    {<br />        return new InvalidOperationException(string.Format(<br />            &quot;Sorry, you have encountered a rare .NET bug. &quot; +<br />            &quot;Control '{1}', which is the parent control of &quot; + <br />            &quot;'{0}', contains '&lt;% %&gt;' tags. Because of the &quot; + <br />            &quot;existance of those tags, this parent control &quot; + <br />            &quot;can not be modified and it is impossible to &quot; + <br />            &quot;dynamically add validators to it. You can &quot; + <br />            &quot;fix this by wrapping '{0}' in another control&quot; + <br />            &quot;. For instance: &quot; + <br />            &quot;&lt;asp:{2} runat='server' ID='{1}'&gt;&quot; +<br />                &quot;&lt;asp:PlaceHolder runat='server'&gt;&quot; + <br />                    &quot;&lt;asp:{3} runat='server' id='{0}' /&gt;&quot; + <br />                &quot;&lt;/asp:PlaceHolder&gt;&quot; +<br />            &quot;&lt;/asp:{2}&gt;. {4}&quot;, control.ID, control.Parent.ID, <br />            control.Parent.GetType().Name, <br />            control.GetType().Name, exception.Message));<br />    }<br />}</pre><p>The trick here is that the <span class="type">AspNetValidationIntegration</span> class now only has one single extension method named <span class="code">For&lt;TEntity&gt;</span> which will return a new <span class="type">AspNetValidationIntegrator</span><span class="code">&lt;TEntity&gt;</span>. The magic happens in the <span class="code">AddConverter</span> method. In this method the <span class="type">PropertyProxyValidator</span>'s <span class="code">ValueConvert</span> event is hooked. Here is that method again:</p><pre class="cs" language="csharp" customtypes="PropertyProxyValidator" customvaluetypes="PutYourCustomValueTypesHere">&nbsp;    private static void AddConverter&lt;TValue&gt;(<br />        PropertyProxyValidator proxy, <br />        Func&lt;string, TValue&gt; converter, string errorMessage)<br />    {<br />        if (converter != null)<br />        {<br />            proxy.ValueConvert += (sender, e) =&gt;<br />            {<br />                string value = e.ValueToConvert as string;<br />                try<br />                {<br />                    e.ConvertedValue = converter(value);<br />                }<br />                catch (Exception ex)<br />                {<br />                    if (string.IsNullOrEmpty(errorMessage))<br />                    {<br />                        e.ConversionErrorMessage = ex.Message;<br />                    }<br />                    else<br />                    {<br />                        e.ConversionErrorMessage = errorMessage;<br />                    }<br /><br />                    e.ConvertedValue = null;<br />                }<br />            };<br />        }<br />    }</pre><p>The <span class="code">AddConverter</span> method hooks an anonymous method to the <span class="code">ValueConvert</span> event. The <span class="code">converter</span> and <span class="code">errorMessage</span> arguments are used as closures in this anonymous methods and used to do the actual convertion and display an message when the conversion fails.</p><p>Just as before this code hides the use of the <span class="type">PropertyProxyValidator</span> and even the use of the Validation Application block from the presentation layer. Validation Application Block is now just an implementation detail, which, from an architectural perspective, is a good thing.</p><p>Happy validating!</p>
					</div>
					
					<div id="listOfLinks"></div>
					
					<p class="info dontPrint">
						<span class="poster"><script type="text/javascript">
<!--
	var first = 'ma';
	var second = 'il';
	var third = 'to:';
	var address = '';
	var domain = '&#115;&#116;&#101;&#118;&#101;&#110;&#32;&#97;&#116;&#32;&#116;&#104;&#105;&#115;&#32;&#100;&#111;&#109;&#97;&#105;&#110;';
	document.write('<a href="');
	document.write(first+second+third);
	document.write(address);
	document.write('&#64;');
	document.write(domain);
	document.write('" title="Email Steven">');
	document.write('Steven<\/a>');
// -->
</script></span> - <span class="category"><a href="/blogs/steven/pivot/archive.php?c=ASP.NET">ASP.NET</a>, <a href="/blogs/steven/pivot/archive.php?c=6">C#</a>, <a href="/blogs/steven/pivot/archive.php?c=Enterprise_Library">Enterprise Library</a>, <a href="/blogs/steven/pivot/archive.php?c=Validation_Application_Block">Validation Application Block</a></span> - 
						<span class="comments"><a href="/blogs/steven/pivot/entry.php?id=79#comm" title="Scott Williams, Steven, Mandeep">four comments</a> /  <a href="/blogs/steven/pivot/entry.php?id=79#track" title="">No trackbacks</a></span> - 
						<a href="/blogs/steven/archives/archive_2010-m08.php#e79" title="Permanent link to 'Integrating Validation Application Block with ASP.NET part 2' in the archives">&sect;</a> <a href="/blogs/steven/pivot/entry.php?id=79" title="Permanent link to entry 'Integrating Validation Application Block with ASP.NET part 2'">&para;</a> 
					</p>
					
					<div id="NoJavascriptWarning">
						The code samples on my weblog are colorized using javascript, but
						you disabled javascript (for my website) on your browser. 
						If you're interested in viewing the posted code snippets in 
						color, please enable javascript.
					</div>
					<script type="text/javascript">
						var noScriptWarning = document.getElementById('NoJavascriptWarning');
						noScriptWarning.style.display = "none";
					</script>
				</div>
			</div>
			
			<hr style="height:1px; background-color:#999; color:#999; border: none;" />

			<p><b>four comments:</b></p>
			<div class="comments">
			<a id="comm"></a>
<p>Looks good, think I'll give it a shot in something I'm working on.  What technique are you using for client-side validation?<br /><small><b>Scott Williams</b>   - 16 09 10 - 17:05 </small></p>
<p>Hi Scott. I currently only do server-side validation. A technique like described in this article however, should allow us to enable client-side validation by changing it in a single place. I planned to take a more thorough look at client-side validation in the future. When I do, I'll write a post on it. Keep an eye on my blog.<br /><small><b>Steven</b>  (<a href='http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=79'  title='www.cuttingedge.it/blogs/steven/pivot/entry.php?id=79'>URL</a>) - 17 09 10 - 18:55 </small></p>
<p>HI Steve,<br />
<br />
Again, this is a great post of yours. This value conversion errors gave me hard time and it took a while for me to figure out the correct solution. Your  approach is really great as we are adding value conversion at just one place.<br />
<br />
When I saw your post I thought there must be a more simple approach to this and I am going to help you.<br />
<br />
In the CreateValidatorFor function from the previous post please add following line<br />
proxy.ValueConvert += (sender, e) => { };<br />
and that's it, you do not need to do anything from this post.<br />
<br />
To simplify more, you can move code from BindProxyValidatorToDomainProperty to CreateValidatorFor and delete BindProxyValidatorToDomainProperty function.<br />
<br />
Again, I really appreciate your efforts and your are the one who have shown us this guidance to make validation really simple, easy to implement. Adding PropertyProxyValidator and ServerSideValidationExtender for each control in the markup was a pain and error prone. Code was getting cluttered with lot of crap.<br />
<br />
Thanks,<br />
Mandeep.<br /><small><b>Mandeep</b>  (<a href='http://www.mandeepjanjua.com'  title='www.mandeepjanjua.com'>URL</a>) - 30 07 11 - 16:27 </small></p>
<a id="lastcomment"></a><p>The valueconvert function will show the error message defined in the TypeConversionValidator attribute<br />
<br />
[TypeConversionValidator(typeof(int), MessageTemplate = "Please enter numeric values only")]<br />
        public int Age<br />
        {<br />
            get;<br />
            set;<br />
        }<br /><small><b>Mandeep</b>  (<a href='http://www.mandeepjanjua.com'  title='www.mandeepjanjua.com'>URL</a>) - 30 07 11 - 16:35 </small></p>

			</div>

		</div>

		<hr />
		
		<div id="footer">
			<p>&copy; 2007-2019 Steven van Deursen.<br /><span class="dontPrint"><a href="/blogs/steven/rss.xml" title="XML: RSS Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/rssbutton.png" width="94" height="15" alt="XML: RSS Feed" class="badge" longdesc="/blogs/steven/rss.xml" /></a> <a href="/blogs/steven/atom.xml" title="XML: Atom Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/atombutton.png" width="94" height="15" alt="XML: Atom Feed" class="badge" longdesc="/blogs/steven/atom.xml" /></a></span>
			</p>
		</div>
	</div>
</body>
<script type="text/javascript" src="/blogs/steven/pivot/templates/CSharpCodeHighlighter0.10.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/MSILCodeHighlighter0.1.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/X86CodeHighlighter0.1.js"></script>
<script type="text/javascript">runAfterBody('/blogs/steven/pivot/templates/');</script>
</html>