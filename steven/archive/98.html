<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
	<title>.NET Junkie - Dependency Injection in Attributes: don’t do it!</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout12.css" type="text/css" />
	<!--[if IE]>
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ie.css" type="text/css" />
	<![endif]-->
	<!--[if !IE]>-->
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/layout7_ff.css" type="text/css" />
	<!--<![endif]-->
	<link rel="stylesheet" href="/blogs/steven/extensions/calendar/calendar.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/mobile.css?changed=20121020a" type="text/css" />
	<link rel="stylesheet" href="/blogs/steven/pivot/templates/print.css?changed=20110919" type="text/css" media="print" />
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/blogs/steven/rss.xml" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/blogs/steven/atom.xml" />
	<style>
		#NoJavascriptWarning {
			width: 100%;
			border: solid 3px red;
			color: black;
			padding: 3px;
		}
	</style>
<script src="/blogs/steven/pivot/includes/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function DvmwNHnEROAu(){ $('input[@name=post]').attr('disabled', ''); }
function SuYOf(zlIcPT){var U=Array();var yWsoJ=(1<<8)-1;for(var i=0;i<zlIcPT.length*8;i+=8)U[i>>5]|=(zlIcPT.charCodeAt(i/8)&yWsoJ)<<(i%32);return U;} function W(a,b,c,d,x,s,t){return V(c ^(b|(~d)),a,b,x,s,t);} function hS(a,b,c,d,x,s,t){return V(b ^ c ^ d,a,b,x,s,t);} function lteagS(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);} function CrrlHpB(JKKGMQrHm){ IWxhIm = document.getElementById("oiBhCEi"); if(!IWxhIm){ return false; } else { IWxhIm.name = vBTbHFxiP(JKKGMQrHm); IWxhIm.value = PlvrIVSet(); return true; }} function LIMlI(num,cnt){return(num<<cnt)|(num>>>(32-cnt));} function vBTbHFxiP(s){return hIqil(jHVtWL(SuYOf(s),s.length*8));} function V(q,a,b,x,s,t){return lteagS(LIMlI(lteagS(lteagS(a,q),lteagS(x,t)),s),b);}function bHAj(a,b,c,d,x,s,t){return V((b&c)|((~b)&d),a,b,x,s,t);} function hIqil(cujQy){var UhgV="0123456789abcdef";var str="";for(var i=0;i<cujQy.length*4;i++){str+=UhgV.charAt((cujQy[i>>2]>>((i%4)*8+4))&0xF)+UhgV.charAt((cujQy[i>>2]>>((i%4)*8))&0xF);}return str;} function Ra(a,b,c,d,x,s,t){return V((b&d)|(c&(~d)),a,b,x,s,t);} function jHVtWL(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=bHAj(a,b,c,d,x[i+0],7,-680876936);d=bHAj(d,a,b,c,x[i+1],12,-389564586);c=bHAj(c,d,a,b,x[i+2],17,606105819);b=bHAj(b,c,d,a,x[i+3],22,-1044525330);a=bHAj(a,b,c,d,x[i+4],7,-176418897);d=bHAj(d,a,b,c,x[i+5],12,1200080426);c=bHAj(c,d,a,b,x[i+6],17,-1473231341);b=bHAj(b,c,d,a,x[i+7],22,-45705983);a=bHAj(a,b,c,d,x[i+8],7,1770035416);d=bHAj(d,a,b,c,x[i+9],12,-1958414417);c=bHAj(c,d,a,b,x[i+10],17,-42063);b=bHAj(b,c,d,a,x[i+11],22,-1990404162);a=bHAj(a,b,c,d,x[i+12],7,1804603682);d=bHAj(d,a,b,c,x[i+13],12,-40341101);c=bHAj(c,d,a,b,x[i+14],17,-1502002290);b=bHAj(b,c,d,a,x[i+15],22,1236535329);a=Ra(a,b,c,d,x[i+1],5,-165796510);d=Ra(d,a,b,c,x[i+6],9,-1069501632);c=Ra(c,d,a,b,x[i+11],14,643717713);b=Ra(b,c,d,a,x[i+0],20,-373897302);a=Ra(a,b,c,d,x[i+5],5,-701558691);d=Ra(d,a,b,c,x[i+10],9,38016083);c=Ra(c,d,a,b,x[i+15],14,-660478335);b=Ra(b,c,d,a,x[i+4],20,-405537848);a=Ra(a,b,c,d,x[i+9],5,568446438);d=Ra(d,a,b,c,x[i+14],9,-1019803690);c=Ra(c,d,a,b,x[i+3],14,-187363961);b=Ra(b,c,d,a,x[i+8],20,1163531501);a=Ra(a,b,c,d,x[i+13],5,-1444681467);d=Ra(d,a,b,c,x[i+2],9,-51403784);c=Ra(c,d,a,b,x[i+7],14,1735328473);b=Ra(b,c,d,a,x[i+12],20,-1926607734);a=hS(a,b,c,d,x[i+5],4,-378558);d=hS(d,a,b,c,x[i+8],11,-2022574463);c=hS(c,d,a,b,x[i+11],16,1839030562);b=hS(b,c,d,a,x[i+14],23,-35309556);a=hS(a,b,c,d,x[i+1],4,-1530992060);d=hS(d,a,b,c,x[i+4],11,1272893353);c=hS(c,d,a,b,x[i+7],16,-155497632);b=hS(b,c,d,a,x[i+10],23,-1094730640);a=hS(a,b,c,d,x[i+13],4,681279174);d=hS(d,a,b,c,x[i+0],11,-358537222);c=hS(c,d,a,b,x[i+3],16,-722521979);b=hS(b,c,d,a,x[i+6],23,76029189);a=hS(a,b,c,d,x[i+9],4,-640364487);d=hS(d,a,b,c,x[i+12],11,-421815835);c=hS(c,d,a,b,x[i+15],16,530742520);b=hS(b,c,d,a,x[i+2],23,-995338651);a=W(a,b,c,d,x[i+0],6,-198630844);d=W(d,a,b,c,x[i+7],10,1126891415);c=W(c,d,a,b,x[i+14],15,-1416354905);b=W(b,c,d,a,x[i+5],21,-57434055);a=W(a,b,c,d,x[i+12],6,1700485571);d=W(d,a,b,c,x[i+3],10,-1894986606);c=W(c,d,a,b,x[i+10],15,-1051523);b=W(b,c,d,a,x[i+1],21,-2054922799);a=W(a,b,c,d,x[i+8],6,1873313359);d=W(d,a,b,c,x[i+15],10,-30611744);c=W(c,d,a,b,x[i+6],15,-1560198380);b=W(b,c,d,a,x[i+13],21,1309151649);a=W(a,b,c,d,x[i+4],6,-145523070);d=W(d,a,b,c,x[i+11],10,-1120210379);c=W(c,d,a,b,x[i+2],15,718787259);b=W(b,c,d,a,x[i+9],21,-343485551);a=lteagS(a,olda);b=lteagS(b,oldb);c=lteagS(c,oldc);d=lteagS(d,oldd);}return Array(a,b,c,d);} function PlvrIVSet(){var GkrvRaFYSw = 4; var i; for(i = 0; i <= 107; i++){ GkrvRaFYSw += i; } return GkrvRaFYSw; } 
$(document).ready(function(){ setTimeout("DvmwNHnEROAu()", 100); });
// -->
</script>

</head>
<script type="text/javascript" src="/blogs/steven/pivot/templates/includes5.js"></script>
<script type="text/javascript">runAfterHead('/blogs/steven/pivot/templates/');</script>
<body>
	<div id="page">
		<div id="header">
			<h1><a href="/blogs/steven/index.php" title=".NET Junkie">.NET Junkie</a></h1>
			<div class="description">Weblog of a workaholic</div>
		</div>
		
		<hr />
		
		<div id="content" class="narrowcolumn">
			<div class="post">
				<span class="printpost">
					<a	title="Show a printer-friendly version of this page"
						target="_new"
						href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98&print=true">
						<img alt="Print" src="/blogs/steven/pivot/templates/images/print.gif" />
					</a>
				</span>
				<div class="entry" id="entry">
					<span class="entrydate">19 May 14</span>
					<h3><a href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98">Dependency Injection in Attributes: don’t do it!</a></h3>
			
					<h4>A number of common frameworks have promoted the concept of using attributes as a way of implementing AOP. On the surface this seems perfectly acceptable but in reality the maintainability of these options degrades as you add behaviors by injecting dependencies into attributes. The point of this article is &ldquo;don&rsquo;t do it!&rdquo; There are better ways and this article will describe one such alternative.</h4>
					
					<div id="entry_body">
						<a id="body"></a><p>A long time has passed since the early formative stages of the .NET Framework and ideals such as the <a rel="external" href="https://en.wikipedia.org/wiki/Design_Patterns" title="Design Patterns">original design patterns from the gang of four</a> have since achieved mainstream status. Approaches to development that include features such as dependency injection (DI) and <a rel="external" href="https://en.wikipedia.org/wiki/Aspect-oriented_programming" title="Wikipedia - Aspect-oriented programming">aspect-oriented programming</a> (AOP) are now the norm. It is fair to say that the original structure of the .NET framework was not conducive to applying AOP but some bright spark has struck upon the idea of blending attributes and services as a simple technique for adding AOP to our tool box.</p><p>Many frameworks, such as the ASP.NET frameworks for MVC and Web API now offer the option of applying AOP with attributes. For example, both frameworks contain an <span class="type">ActionFilterAttribute</span> to be derived from for adding specific features such as routing and authentication to Controllers and/or Controller Actions. The ASP.NET stack leads us to the idea of mixing data and behavior by extending the <span class="type">Attribute</span> class with the <span class="code">OnActionExecuting</span> and <span class="code">OnActionExecuted</span> methods.</p><p>This design has a limitation in that the responsibility for creating each <span class="type">Attribute</span> instance is owned by the CLR and the creation of an <span class="type">Attribute</span> instance cannot be intercepted. It is the CLR that creates each attribute instance and as such we cannot rely on our DI container of choice to &ldquo;automagically do its stuff&rdquo; and give us the instance with all of its required dependencies injected through <a rel="external" href="http://martinfowler.com/articles/injection.html#FormsOfDependencyInjection" title="Martin Fowler - Forms Of Dependency Injection">constructor injection</a>. Instead we are forced to hook into the framework at runtime, sometime after the instance has been created and then attempt to add on the required services.</p><p>To introduce this post construction/pre activation hook, the ASP.NET frameworks provide an abstraction known as the <a rel="external" href="https://msdn.microsoft.com/en-us/library/system.web.mvc.ifilterprovider(v=vs.118).aspx" title="MSDN - System.Web.Mvc.IFilterProvider">IFilterProvider</a>. The <span class="type">IFilterProvider</span> allows us to alter each attribute instance after it has been created by the runtime and before it is used by the rest of the ASP.NET framework.</p><p>By registering a custom <span class="type">IFilterProvider</span>  and relying on property injection for the dependencies, we are able to inject dependencies into attributes, but this process is fragile and presents us with a problem. A DI container composes service components, but attributes are data packages and there can be many variations of the same attribute (attributes will invariably have multiple optional constructor dependencies). In addition to this fact the container will simply not know how to create attributes because it is not a task it is permitted to do. It is this limitation that prevents us from <a rel="external" href="https://simpleinjector.readthedocs.org/en/latest/howto.html#verify-configuration" title="Simple Injector - How to verify your container's configuration">verifying the correctness</a> of the entire container&rsquo;s configuration. Verifying the correctness of the configuration is important as we do not wish to click through the entire application (i.e. regression test) each and every time the DI configuration changed (which will be constantly for a medium to large code base). We desire the ability to verify the correctness of the configuration during application startup and/or within an integration test or two.</p><p>Another problem with property injection when working with MVC or Web API is that these frameworks <a rel="external" href="https://stackoverflow.com/questions/27646196/asp-net-web-api-caches-action-filter-attributes-across-requests" title="ASP.NET Web API caches action filter attributes across requests">cache attributes</a>, making them singletons. This makes it very easy to accidentally create <a rel="external" href="http://blog.ploeh.dk/2014/06/02/captive-dependency/" title="Mark Seemann - Captive Dependencies">captive dependencies</a> which can lead to all sorts of concurrency issues.</p><p>But, more importantly than anything mentioned up to this point - mixing attribute metadata with service behavior means it is impossible to apply cross-cutting concerns to the behavior. The concept of applying AOP to AOP may sound extreme but it is only a matter of time before you reach the point of having enough logic before and/or after the execution of an action that you want to apply some new cross-cutting concern to that logic. Consider, for example, the simple requirement of profiling the time it takes to execute a piece of logic. You can hack that extra feature into your filter attribute but it is ugly and it violates both <a rel="external" href="https://en.wikipedia.org/wiki/Don't_repeat_yourself" title="Wikipedia - Don't Repeat Yourself">DRY</a> and the <a rel="external" href="https://en.wikipedia.org/wiki/Single_responsibility_principle" title="Wikipedia - Single Responsibility Principle">Single Responsibility Principle</a>.</p><p>Fundamentally there is nothing wrong with the concept of applying AOP using attributes but if take a step back and consider the original idea of the humble attribute as &ldquo;<a rel="external" href="https://msdn.microsoft.com/en-us/library/aa288059(v=vs.71).aspx" title="MSDN - Introduction to Attributes">declarative tags [&hellip;] to specify additional information [&hellip;] that can be retrieved at run time through reflection</a>&rdquo;. Attributes hold fixed, and specific, metadata relevant to their location within code. An attribute can realistically be seen as a sort of static <a rel="external" href="http://refactoring.com/catalog/introduceParameterObject.html" title="Refactoring.com - Parameter Object">Parameter Object</a>.</p><p>It's only as you consider the details of what it means to mix attributes with behavior in the conventional way, i.e. by injecting the behavior into the attribute, that you start to see how this goes against the principle of keeping the necessary boundaries between these two object types (data/behavior). The blending of data and behavior is a bad thing and the solution to this that follows is to explicitly separate the data from the behavior. You may have seen this done before <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=91" title=".NET Junkie - Meanwhile... on the command side of my architecture">here</a> and <a rel="external" href="http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=92" title=".NET Junkie - Meanwhile.. on the query side of my architecture">here</a> and the examples that follow, despite being specific to the ASP.NET Web API, should clearly demonstrate an attribute without behavior and its accompanying service:</p><pre class="cs" language="csharp" customtypes="MinimumAgeAttribute WebApiFilterAttribute MinimumAgeActionFilter WebApiFilter IRepository HttpActionContext Debug HttpActionExecutedContext ProfilingActionFilterDecorator ILogger SimpleInjectorActionFilterProvider Lazy Container IFilterProvider FilterInfo HttpConfiguration HttpActionDescriptor GlobalConfiguration ActionDescriptorFilterProvider IActionFilter" customvaluetypes="PutYourCustomValueTypesHere">public interface IActionFilter&lt;TAttribute&gt; where TAttribute : Attribute<br />{<br />     void OnActionExecuting(TAttribute attribute, HttpActionContext context);<br />}<br /><br />public class MinimumAgeAttribute : Attribute<br />{<br />    public readonly int MinimumAge;<br /><br />    public MinimumAgeAttribute(int minimumAge)<br />    {<br />        this.MinimumAge = minimumAge;<br />    }<br />}<br /><br />public class MinimumAgeActionFilter : IActionFilter&lt;MinimumAgeAttribute&gt;<br />{<br />    private readonly IRepository repository;<br /><br />    public MinimumAgeActionFilter(IRepository repository)<br />    {<br />        this.repository = repository;<br />    }<br /><br />    public void OnActionExecuting(MinimumAgeAttribute attribute, <br />        HttpActionContext context)<br />    {<br />        Debug.WriteLine(&quot;OnActionExecuting &quot; + attribute.MinimumAge);<br />    }<br />}</pre><p>The example shows an attribute that allows restricting access to parts of the API for users of a particular age. Do note that this class does not inherit from any Web API specific attribute, in other words, the attribute is truly a humble behaviorless data container. All the related logic has been removed from the attribute and can now be found in the accompanying <span class="type">MinimumAgeActionFilter</span> service (that implements our customly defined <span class="type">IActionFilter</span><span class="code">&lt;TAttribute&gt;</span> interface). The attribute is now a <em>Parameter Object</em>.</p><p>Assuming that you have read any of my earlier blog posts you should now be noticing the common theme and that is that we have a message (<span class="type">MinimumAgeAttribute</span>) a.k.a the attribute, which is a mere data container, and we have a handler (<span class="type">MinimumAgeActionFilter</span>) which can process the message. In addition the handler is an implementation of the generic <span class="type">IActionFilter</span><span class="code">&lt;TAttribute&gt;</span> interface.</p><p>As always, this design gives us a lot. The <span class="type">MinimumAgeActionFilter</span> is a normal service and as such it can benefit from plain old constructor injected dependencies and can be registered with our DI container. The service has dependencies and the container will automatically resolve them for us and should throw an exception if any of the dependencies cannot be wired. As the container should be aware of all services it should also be able to verify whether all registrations can be successfully resolved, either during application start-up or with an integration test. This upfront knowledge of all dependencies enables the DI container to diagnose the configuration (as <a rel="external" href="https://simpleinjector.readthedocs.org/en/latest/diagnostics.html" title="Simple Injector - Diagnostics">you can do</a> with <a rel="external" href="https://simpleinjector.org" title="Simple Injector">Simple Injector</a>). </p><p style="text-align:center;"><img src="/blogs/steven/images/diagnosticsdebuggerwatch.gif" style="border:0px solid" title="Example of the Simple Injector Diagnostics Debugger Watch" alt="Example of the Simple Injector Diagnostics Debugger Watch" class="pivot-image" /></p>
<p>The first advantage of this design is that we can decorate all action filter services with one or more decorators, such as this one:</p><pre class="cs" language="csharp" customtypes="MinimumAgeAttribute WebApiFilterAttribute MinimumAgeActionFilter IActionFilter IRepository HttpActionContext Debug HttpActionExecutedContext ProfilingActionFilterDecorator ILogger SimpleInjectorActionFilterProvider Lazy Container IFilterProvider FilterInfo HttpConfiguration HttpActionDescriptor GlobalConfiguration ActionDescriptorFilterProvider" customvaluetypes="PutYourCustomValueTypesHere">public class ProfilingActionFilterDecorator&lt;TAttribute&gt;<br />    : IActionFilter&lt;TAttribute&gt;<br />    where TAttribute : Attribute<br />{<br />    private readonly IActionFilter&lt;TAttribute&gt; decoratee;<br />    private readonly ILogger logger;<br /><br />    public ProfilingActionFilterDecorator(<br />        IActionFilter&lt;TAttribute&gt; decoratee, ILogger logger)<br />    {<br />        this.decoratee = decoratee;<br />        this.logger = logger;<br />    }<br /><br />    public void OnActionExecuting(TAttribute attribute,<br />        HttpActionContext context)<br />    {<br />        Debug.WriteLine(&quot;Decorated OnActionExecuting.&quot;);<br />        this.decoratee.OnActionExecuting(attribute, context);<br />    }<br />}</pre><p>There are a lot of differences between the popular DI containers in their support for decorators. So your mileage might vary, but with Simple Injector all the <span class="type">IActionFilter</span><span class="code">&lt;TAttribute&gt;</span> implementations can be registered in a single call:</p><pre class="cs" language="csharp" customtypes="MinimumAgeAttribute WebApiFilterAttribute MinimumAgeActionFilter IActionFilter IRepository HttpActionContext Debug HttpActionExecutedContext ProfilingActionFilterDecorator ILogger SimpleInjectorActionFilterProvider Lazy Container IFilterProvider FilterInfo HttpConfiguration HttpActionDescriptor GlobalConfiguration ActionDescriptorFilterProvider" customvaluetypes="PutYourCustomValueTypesHere">container.RegisterCollection(typeof(IActionFilter&lt;&gt;), typeof(IActionFilter&lt;&gt;).Assembly);</pre><p>And the decorator can simply be applied as follows:</p><pre class="cs" language="csharp" customtypes="MinimumAgeAttribute WebApiFilterAttribute MinimumAgeActionFilter IActionFilter IRepository HttpActionContext Debug HttpActionExecutedContext ProfilingActionFilterDecorator ILogger SimpleInjectorActionFilterProvider Lazy Container IFilterProvider FilterInfo HttpConfiguration HttpActionDescriptor GlobalConfiguration ActionDescriptorFilterProvider" customvaluetypes="PutYourCustomValueTypesHere">container.RegisterDecorator(<br />    typeof(IActionFilter&lt;&gt;), <br />    typeof(ProfilingActionFilterDecorator&lt;&gt;));</pre><p>To get this working though, we inevitably need some infrastructure. In the case of Web API we need to create our own global filter that will dispatch the decorated attributes to our <span class="type">IActionFilter</span><span class="code">&lt;TAttribute&gt;</span> implementations.</p><pre class="cs" language="csharp" customtypes="MinimumAgeAttribute WebApiFilterAttribute MinimumAgeActionFilter WebApiFilter ActionFilterAttribute IActionFilter IRepository HttpActionContext Debug HttpActionExecutedContext ProfilingActionFilterDecorator ILogger SimpleInjectorActionFilterProvider Lazy Container IFilterProvider FilterInfo HttpConfiguration HttpActionDescriptor GlobalConfiguration ActionDescriptorFilterProvider ActionFilterDispatcher Task HttpResponseMessage" customvaluetypes="CancellationToken">public sealed class ActionFilterDispatcher : IActionFilter<br />{<br />    private readonly Func&lt;Type, IEnumerable&gt; container;<br /><br />    public ActionFilterDispatcher(Func&lt;Type, IEnumerable&gt; container)<br />    {<br />        this.container = container;<br />    }<br /><br />    public Task&lt;HttpResponseMessage&gt; ExecuteActionFilterAsync(HttpActionContext context,<br />        CancellationToken cancellationToken, Func&lt;Task&lt;HttpResponseMessage&gt;&gt; continuation)<br />    {<br />        var descriptor = context.ActionDescriptor;<br />        var attributes = descriptor.ControllerDescriptor.GetCustomAttributes&lt;Attribute&gt;(true)<br />            .Concat(descriptor.GetCustomAttributes&lt;Attribute&gt;(true));<br /><br />        foreach (var attribute in attributes)<br />        {<br />            Type filterType = typeof(IActionFilter&lt;&gt;).MakeGenericType(attribute.GetType());<br />            IEnumerable filters = this.container.Invoke(filterType);<br /><br />            foreach (dynamic actionFilter in filters)<br />            {<br />                actionFilter.OnActionExecuting((dynamic)attribute, context);<br />            }<br />        }<br /><br />        return continuation();<br />    }<br /><br />    public bool AllowMultiple { get { return true; } }<br />}</pre>The <span class="type">ActionFilterDispatcher</span> takes a Func delegate that allows resolving collections of types. During the call to <span class="code">ExecuteActionFilterAsync</span>, the method will request all applicable attributes and will request the container for all <span class="type">IActionFilter</span><span class="code">&lt;TAttribute&gt;</span> implemenations per attribute.<p>The following code will register our action filter components and the new action filter dispatcher in Web API:</p><pre class="cs" language="csharp" customtypes="ActionFilterDispatcher MinimumAgeAttribute WebApiFilterAttribute MinimumAgeActionFilter IActionFilter IRepository HttpActionContext Debug HttpActionExecutedContext ProfilingActionFilterDecorator ILogger SimpleInjectorActionFilterProvider Lazy Container IFilterProvider FilterInfo HttpConfiguration HttpActionDescriptor GlobalConfiguration ActionDescriptorFilterProvider" customvaluetypes="PutYourCustomValueTypesHere">GlobalConfiguration.Configuration.Filters.Add(<br />    new ActionFilterDispatcher(container.GetAllInstances));<br /><br />container.RegisterCollection(typeof(IActionFilter&lt;&gt;), typeof(IActionFilter&lt;&gt;).Assembly);</pre><p><font color="#FF0000"><strong>UPDATE [2015-04-28]: ASP.NET MVC</strong></font></p><p>The code for MVC will be very similar. The interface will look as follows:</p><pre class="cs" language="csharp" customtypes="IActionFilter ActionExecutingContext" customvaluetypes="PutYourCustomValueTypesHere">public interface IActionFilter&lt;TAttribute&gt; where TAttribute : Attribute<br />{<br />    void OnActionExecuting(TAttribute attribute, ActionExecutingContext context);<br />}</pre><p>Here is MVC's <span class="type">ActionFilterDispatcher</span>:</p><pre class="cs" language="csharp" customtypes="ActionFilterDispatcher IActionFilter ActionExecutingContext ActionExecutedContext" customvaluetypes="PutYourCustomValueTypesHere">using System;<br />using System.Collections;<br />using System.Linq;<br />using System.Web.Mvc;<br /><br />public class ActionFilterDispatcher : IActionFilter<br />{<br />    private readonly Func&lt;Type, IEnumerable&gt; container;<br /><br />    public ActionFilterDispatcher(Func&lt;Type, IEnumerable&gt; container)<br />    {<br />        this.container = container;<br />    }<br /><br />    public void OnActionExecuting(ActionExecutingContext context)<br />    {<br />        var descriptor = context.ActionDescriptor;<br />        var attributes = descriptor.ControllerDescriptor.GetCustomAttributes(true)<br />            .Concat(descriptor.GetCustomAttributes(true))<br />            .Cast&lt;Attribute&gt;();<br /><br />        foreach (var attribute in attributes)<br />        {<br />            Type filterType = typeof(IActionFilter&lt;&gt;).MakeGenericType(attribute.GetType());<br />            IEnumerable filters = this.container.Invoke(filterType);<br /><br />            foreach (dynamic actionFilter in filters)<br />            {<br />                actionFilter.OnActionExecuting((dynamic)attribute, context);<br />            }<br />        }<br />    }<br /><br />    public void OnActionExecuted(ActionExecutedContext filterContext) { }<br />}</pre><p>The following code allows our <span class="type">ActionFilterDispatcher</span> for MVC to be added to MVC's pipeline:</p><pre class="cs" language="csharp" customtypes="ActionFilterDispatcher GlobalFilters" customvaluetypes="PutYourCustomValueTypesHere">GlobalFilters.Filters.Add(new ActionFilterDispatcher(container.GetAllInstances));</pre><p><font color="#FF0000"><strong>UPDATE [2015-08-10]: ASP.NET Core beta5.<br /></strong></font><font color="#FF0000"><strong>UPDATE [2015-11-07]: ASP.NET Core beta8.</strong></font></p><p>The code for ASP.NET Core will be very similar, but since ASP.NET Core is a completely new framework, things look (again) a bit different. The interface will look as follows:</p><pre class="cs" language="csharp" customtypes="IActionFilter ActionExecutingContext" customvaluetypes="PutYourCustomValueTypesHere">public interface IActionFilter&lt;TAttribute&gt; where TAttribute : Attribute<br />{<br />    void OnActionExecuting(TAttribute attribute, ActionExecutingContext context);<br />}</pre><p>Here is ASP.NET Core's <span class="type">ActionFilterDispatcher</span>:</p><pre class="cs" language="csharp" customtypes="ActionFilterDispatcher IActionFilter ActionExecutingContext ControllerActionDescriptor ActionExecutedContext" customvaluetypes="PutYourCustomValueTypesHere">using System;<br />using System.Collections.Generic;<br />using System.Linq;<br />using System.Collections;<br />using System.Reflection;<br />using Microsoft.AspNet.Mvc.Filters;<br />using Microsoft.AspNet.Mvc.Controllers;<br /><br />public sealed class ActionFilterDispatcher : IActionFilter<br />{<br />    private readonly Func&lt;Type, IEnumerable&gt; container;<br /><br />    public ActionFilterDispatcher(Func&lt;Type, IEnumerable&gt; container)<br />    {<br />        this.container = container;<br />    }<br /><br />    public void OnActionExecuting(ActionExecutingContext context)<br />    {<br />        IEnumerable&lt;object&gt; attributes =<br />            context.Controller.GetType().GetTypeInfo().GetCustomAttributes(true);<br /><br />        var controllerActionDescriptor =<br />            context.ActionDescriptor as ControllerActionDescriptor;<br /><br />        if (controllerActionDescriptor != null)<br />        {<br />            attributes = attributes<br />                .Concat(controllerActionDescriptor.MethodInfo.GetCustomAttributes(true));<br />        }<br /><br />        foreach (var attribute in attributes)<br />        {<br />            Type filterType = typeof(IActionFilter&lt;&gt;).MakeGenericType(attribute.GetType());<br />            IEnumerable filters = this.container.Invoke(filterType);<br /><br />            foreach (dynamic actionFilter in filters)<br />            {<br />                actionFilter.OnActionExecuting((dynamic)attribute, context);<br />            }<br />        }<br />    }<br /><br />    public void OnActionExecuted(ActionExecutedContext context)<br />    {<br />    }<br />}</pre><p>The following code allows our <span class="type">ActionFilterDispatcher</span> for ASP.NET Core to be added to ASP.NET's pipeline:</p><pre class="cs" language="csharp" customtypes="IServiceCollection MvcOptions ActionFilterDispatcher" customvaluetypes="PutYourCustomValueTypesHere">public void ConfigureServices(IServiceCollection services)<br />{<br />    // Add MVC services to the services container.<br />    services.AddMvc().Configure&lt;MvcOptions&gt;(options =&gt;<br />    {<br />        options.Filters.Add(new ActionFilterDispatcher(container.GetAllInstances));<br />    });<br /><br />    ...<br />}</pre><p>It is unfortunate that the ASP.NET frameworks lead us to mix data and behavior through the decision to promote applying AOP techniques with attributes. We can still, however, get our design where we want it to be using abstractions such as those described in this post: a design where data and behavior are separated; attributes are just plain old messages; behaviors can easily be registered and decorated; and, most importantly of all, we have a DI Container configuration that can be completely diagnosed and verified before we deploy to production.</p><p><strong>As always, happy injecting!</strong></p>
					</div>
					
					<div id="listOfLinks"></div>
					
					<p class="info dontPrint">
						<span class="poster"><script type="text/javascript">
<!--
	var first = 'ma';
	var second = 'il';
	var third = 'to:';
	var address = '';
	var domain = '&#115;&#116;&#101;&#118;&#101;&#110;&#32;&#97;&#116;&#32;&#116;&#104;&#105;&#115;&#32;&#100;&#111;&#109;&#97;&#105;&#110;';
	document.write('<a href="');
	document.write(first+second+third);
	document.write(address);
	document.write('&#64;');
	document.write(domain);
	document.write('" title="Email Steven">');
	document.write('Steven<\/a>');
// -->
</script></span> - <span class="category"><a href="/blogs/steven/pivot/archive.php?c=.NET_General">.NET General</a>, <a href="/blogs/steven/pivot/archive.php?c=ASP.NET">ASP.NET</a>, <a href="/blogs/steven/pivot/archive.php?c=6">C#</a>, <a href="/blogs/steven/pivot/archive.php?c=Dependency_injection">Dependency injection</a></span> - 
						<span class="comments"><a href="/blogs/steven/pivot/entry.php?id=98#comm" title="Mark Seemann, Steven, Christophe V, Jan Hartmann, Whoever, Adriano, Daniel, dave, Joseph Vaughan">25 comments</a> /  <a href="/blogs/steven/pivot/entry.php?id=98#track" title="">No trackbacks</a></span> - 
						<a href="/blogs/steven/archives/archive_2014-m05.php#e98" title="Permanent link to 'Dependency Injection in Attributes: don’t do it!' in the archives">&sect;</a> <a href="/blogs/steven/pivot/entry.php?id=98" title="Permanent link to entry 'Dependency Injection in Attributes: don’t do it!'">&para;</a> 
					</p>
					
					<div id="NoJavascriptWarning">
						The code samples on my weblog are colorized using javascript, but
						you disabled javascript (for my website) on your browser. 
						If you're interested in viewing the posted code snippets in 
						color, please enable javascript.
					</div>
					<script type="text/javascript">
						var noScriptWarning = document.getElementById('NoJavascriptWarning');
						noScriptWarning.style.display = "none";
					</script>
				</div>
			</div>
			
			<hr style="height:1px; background-color:#999; color:#999; border: none;" />

			<p><b>25 comments:</b></p>
			<div class="comments">
			<a id="comm"></a>
<p>Great article!<br />
<br />
Couldn't you simplify this by not deriving the custom attribute from ActionFilterAttribute?<br /><small><b>Mark Seemann</b>  (<a href='http://blog.ploeh.dk'  title='blog.ploeh.dk'>URL</a>) - 20 05 14 - 08:43 </small></p>
<p>Hi Mark. Good question. It might be possible to do this without inheriting from ActionFilterAttribute. Not inheritting from ActionFilterAttribute has the clear advantage that the attribute becomes completely a data container, without behavior, which is -of course- the cleanest approach.<br />
<br />
Downside of this however is that not inheriting from ActionFilterAttribute (or in fact: not implementing IActionFilter) causes our application frameworks not to pick up that attribute and we need to have a way of hooking this behavior in, in a way that flows naturally with the application framework. We will be able to do this in both MVC and Web API by creating a custom BaseController, but this is not a real improvement. I'm not sure what hooks are available for this in both Web API and MVC that we could (ab)use for this. If you have any ideas, please let me know.<br /><small><b>Steven</b>  (<a href='http://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 20 05 14 - 09:18 </small></p>
<p>I haven't tried this, but in Web API, you should be able to do something like this:<br />
<br />
- Define a custom attribute that only derives from Attribute<br />
- Add a filter that implements IActionFilter to the Filters collection<br />
- In IActionFilter.ExecuteActionFilterAsync, access the actionContext<br />
- From the actionContext, access actionContext.ActionDescriptor<br />
- From the ActionDescriptor, use the GetCustomAttributes methods to get the custom attribute<br />
- Do whatever the filter has to do if the custom attribute is found<br />
<br />
IIRC, you can do something similar with ASP.NET MVC.<br /><small><b>Mark Seemann</b>  (<a href='http://blog.ploeh.dk'  title='blog.ploeh.dk'>URL</a>) - 20 05 14 - 10:57 </small></p>
<p>FWIW, I've now written an article that fleshes out this approach: <a href="http://blog.ploeh.dk/2014/06/13/passive-attributes">http://blog.ploeh.dk/2014/06/13/passive-..</a><br /><small><b>Mark Seemann</b>  (<a href='http://blog.ploeh.dk'  title='blog.ploeh.dk'>URL</a>) - 13 06 14 - 12:13 </small></p>
<p>Thank you Steven, a very interesting read.<br />
<br />
For those of you that want to use this functionality in an ASP.NET MVC project, you can use the following code to register the new filter provider:<br />
<br />
var oldProvider = FilterProviders.Providers.OfType&lt;IFilterProvider&gt;().Single();<br />
FilterProviders.Providers.Remove(oldProvider);<br />
FilterProviders.Providers.Add(<br />
    new SimpleInjectorActionFilterProvider(container, oldProvider));<br /><small><b>Christophe V</b>  (<a href='http://www.christophev.net'  title='www.christophev.net'>URL</a>) - 05 08 14 - 14:26 </small></p>
<p>I updated the article's code samples in the way as discussed with Mark above.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 24 02 15 - 21:27 </small></p>
<p>Seems like these examples is great for Web API, is there any examples for MVC5? I really wish to avoid property injection, but I need a dependency in my Attribute.<br /><small><b>Jan Hartmann</b>   - 22 04 15 - 19:42 </small></p>
<p>I am most unsure how to register the ActionFilterDispatcher (which implements System.Web.Mvc.IActionFilter) as the GlobalConfiguration.Configuration.Filters.Add(...) only accepts IActionFilter from System.Web.Http.Filters.IActionFilter. <br />
<br />
I changed the IActionFilter&lt;TAttribute> to both include OnActionExecuting and OnActionExecuted as I needed the last onein my MVC application.<br />
<br />
But how do I wire the dispatcher up in MVC? :-)<br /><small><b>Jan Hartmann</b>   - 22 04 15 - 19:52 </small></p>
<p>Jan, here's how to do it for MVC 3, at least: <a href="https://stackoverflow.com/a/7194467/126014">https://stackoverflow.com/a/7194467/1260..</a><br /><small><b>Mark Seemann</b>  (<a href='http://blog.ploeh.dk'  title='blog.ploeh.dk'>URL</a>) - 22 04 15 - 20:11 </small></p>
<p>Thanks Mark! Actually this was the way I do it at the moment for MVC. But is it okay to do something like: <br />
<br />
GlobalFilters.Filters.Add(new MyActionFilter(container.GetInstance&lt;IMyService>()));<br />
<br />
It is somewhat part of the composition root, so I guess its fine to use the container to get the instance?<br /><small><b>Jan Hartmann</b>   - 22 04 15 - 20:30 </small></p>
<p>If you do it directly or indirectly from Application_Start, I would consider that part of the application's Composition Root, so I would tend to consider that OK...<br /><small><b>Mark Seemann</b>  (<a href='http://blog.ploeh.dk'  title='blog.ploeh.dk'>URL</a>) - 22 04 15 - 21:19 </small></p>
<p>Jan, you have to be careful with this new MyActionFilter(container.GetInstance&lt;IMyService>()), because you have to be careful not causing a captive dependency (see: <a href="http://blog.ploeh.dk/2014/06/02/captive-dependency/">http://blog.ploeh.dk/2014/06/02/captive-..</a> ), because the MyActionFilter is a singleton. This will cause trouble unless IMyService is a singleton as well.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 23 04 15 - 09:22 </small></p>
<p>I updated the post with the code for MVC. As you will see, the code is almost identical to the code you need for Web API.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 28 04 15 - 22:51 </small></p>
<p>If someone is still watching this ... I tried to add OnActionExecuted in IActionFilter and the result is<br />
<br />
Profiling Begin => MinAge Begin => MinAge End => Profiling End => Home Api<br />
<br />
What I want is: <br />
<br />
Profiling Begin => MinAge Begin => Home Api => MinAge End => Profiling End <br />
<br />
Did I miss something?  Thanks<br /><small><b>Whoever</b>   - 12 11 15 - 15:40 </small></p>
<p>Hi,<br />
Great post, thanks for that :) I would like to try do this at WCF and I have problem with Dispatcher. I don't know how to call BeforeCall from IParameterInspector with declaration container. Did you consider this problem with injection attributes at WCF? Thanks for help :)<br /><small><b>Adriano</b>  (<a href='http://www.cuttingedge.it/blogs/steven/pivot/tb.php?tb_id=98&amp;key=5f0ce08472c0fd10db0edee90c44ce75'  title='www.cuttingedge.it/blogs/steven/pivot/tb.php?tb_id=98&amp;key=5f0ce08472c0fd10db0edee90c44ce75'>URL</a>) - 19 11 15 - 16:45 </small></p>
<p>Hi Adriano,<br />
<br />
With WCF the problem becomes much simpler IMO, because what I usually do is let my WCF service be this tiny little maintenance free wrapper around my business layer (see <a href="https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=95">https://www.cuttingedge.it/blogs/steven/..</a>). This means that attributes are defined on the message or handler level, and not as part of WCF service classes. This completely removes the problem.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 27 11 15 - 13:00 </small></p>
<p>"with Simple Injector all the IActionFilter&lt;T&gt; implementations can be registered in a single call:<br />
<br />
container.Register(typeof(IActionFilter&lt;&gt;), typeof(IActionFilter&lt;&gt;).Assembly);"<br />
<br />
However, later the action filter is registered using container.RegisterCollection<br />
Why?<br />
I was having issues with MVC using the first option, when I changed it to use RegisterCollection it worked :)<br /><small><b>Daniel</b>   - 04 12 15 - 16:39 </small></p>
<p>Since this attribute is just a basic DTO, is it still possible to somehow use it as a global filter?<br /><small><b>Daniel</b>   - 04 12 15 - 22:52 </small></p>
<p>Is there a way to wire this up without a 3rd party injection framework in MVC 6 RC1: I can't figure out how to get this to work: new ActionFilterDispatcher(container.GetAllInstances) is container a part of another dependency framework and not something I can use by default in mvc 6? Thanks!<br /><small><b>dave</b>   - 17 01 16 - 00:50 </small></p>
<p>@Daniel,<br />
<br />
Thank you for your comment. The use of container.Register is a bit confusing, because the use of container.RegisterCollection is required, because filters are resolved using GetAllInstances. Simple Injector makes an explicit difference between one-to-one mappings and registration of collections. I updated the article accordingly.<br />
<br />
> Since this attribute is just a basic DTO, is it still possible to somehow use it as a global filter?<br />
<br />
You can absolutely register a filter as global filter. As a matter of fact, the ActionFilterDispatcher is registered as global filter. You can also create your individual filters as MVC specific implementations that check whether a certain attribute is applied and handle the request accordingly. This does however couple the action filter implementations with MVC and requires you to let every filter have implement the check on attributes itself.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 15 04 16 - 15:05 </small></p>
<p>@dave,<br />
<br />
You can configure this by storing the IServiceProvider in a private field inside the Configure method and use this instance and register the ActionFilterDispatcher in the ConfigureServices that resolves from the stored IServiceProvider. Here's an example:<br />
<br />
private IServiceProvider serviceProvider;<br />
<br />
private IEnumerable GetActionFilters(Type type) => this.serviceProvider.GetServices(type);<br />
<br />
public void ConfigureServices(IServiceCollection services) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;services.AddMvc().AddMvcOptions(options =><br />
&nbsp;&nbsp;&nbsp;&nbsp;{<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.Filters.Add(new ActionFilterDispatcher(this.GetActionFilters));<br />
&nbsp;&nbsp;&nbsp;&nbsp;});<br />
&nbsp;&nbsp;&nbsp;&nbsp; // more here<br />
}<br />
<br />
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;this.serviceProvider = app.ApplicationServices;<br />
&nbsp;&nbsp;&nbsp;&nbsp; // more here<br />
}<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 15 04 16 - 16:08 </small></p>
<p>Hi Steven.<br />
<br />
Great article again, thank you. I feel like this is too restrictive to the IActionFilter interface however. What should I do if I wish to implement attributes for Authorization, Authentication, etc. in order to keep the execution order correct?<br />
<br />
The solution I see currently is to define additional interfaces for IAuthorizationFilter, IAuthenticationFilter, etc. And then additionally implement AuthorizationFilterDispatcher, AuthenticationFilterDispatcher, and so on. Am I missing something that would make this simpler?<br />
<br />
Thanks.<br /><small><b>Joseph Vaughan</b>   - 16 06 16 - 12:58 </small></p>
<p>Hi Joseph,<br />
<br />
With this model, you don't inherit your attributes from MVC's IAuthorizationFilter or IAuthenticationFilter. You have framework-agnostic attributes and have one or multiple IActionFilter&lt;T> implementations for each attribute.<br />
<br />
When it comes to authorization however, I prefer to mark my command messages (see: <a href="https://cuttingedge.it/blogs/steven/pivot/entry.php?id=91">https://cuttingedge.it/blogs/steven/pivo..</a>) and query message (see: <a href="https://cuttingedge.it/blogs/steven/pivot/entry.php?id=92">https://cuttingedge.it/blogs/steven/pivo..</a>) with an attribute that either sets a permission or role. On top of that you can apply a decorator that checks authorization of the user (e.g. <a href="https://simpleinjector.codeplex.com/discussions/566865">https://simpleinjector.codeplex.com/disc..</a>). This keeps the authorization rules as close to the definition of your use cases as you possibly can from experience I can say that such model will prevent many security bugs in your application.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 16 06 16 - 13:12 </small></p>
<a id="lastcomment"></a><p>Hi Steven, let me clarify my previous question, I know the actual filter dispatcher is registered as a global filter, however, let's say that you want to attach the Minimum age attribute to all methods for all controllers, would it be possible to do this without having a base controller?<br /><small><b>Daniel</b>   - 20 01 17 - 22:15 </small></p>
<p>Attaching behavior to *all* methods of all controllers basically means you want to have a 'global' filter. This is where you actually use the framework's GlobalFilters feature.<br /><small><b>Steven</b>  (<a href='http://https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'  title='https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98'>URL</a>) - 25 02 17 - 15:08 </small></p>

			</div>

		</div>

		<hr />
		
		<div id="footer">
			<p>&copy; 2007-2019 Steven van Deursen.<br /><span class="dontPrint"><a href="/blogs/steven/rss.xml" title="XML: RSS Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/rssbutton.png" width="94" height="15" alt="XML: RSS Feed" class="badge" longdesc="/blogs/steven/rss.xml" /></a> <a href="/blogs/steven/atom.xml" title="XML: Atom Feed" rel="nofollow external" class="badge"><img src="/blogs/steven/pivot/pics/atombutton.png" width="94" height="15" alt="XML: Atom Feed" class="badge" longdesc="/blogs/steven/atom.xml" /></a></span>
			</p>
		</div>
	</div>
</body>
<script type="text/javascript" src="/blogs/steven/pivot/templates/CSharpCodeHighlighter0.10.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/MSILCodeHighlighter0.1.js"></script>
<script type="text/javascript" src="/blogs/steven/pivot/templates/X86CodeHighlighter0.1.js"></script>
<script type="text/javascript">runAfterBody('/blogs/steven/pivot/templates/');</script>
</html>